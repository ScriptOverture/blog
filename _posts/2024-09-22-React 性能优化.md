---
layout: post
title: React æ€§èƒ½ä¼˜åŒ–
categories: [React]
description: React æ€§èƒ½ä¼˜åŒ–
keywords: React, æ€§èƒ½
---


ç†Ÿæ‚‰ `React` çš„åŒå­¦ä»¬éƒ½çŸ¥é“ï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°éƒ½ä¼šé‡æ–°æ¸²æŸ“ `fiber` æ ‘ï¼ŒåŒ¹é…æ¸²æŸ“ä¼˜å…ˆçº§ç»„ä»¶åŠå…¶æ‰€æœ‰å­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œå­˜åœ¨å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¯èƒ½å¼€å‘ä¸­å¾ˆå¤šåŒå­¦ä¼šæå‡º `useMemo`ï¼Œ`useCallback`, `memo`, `pureComponent`, `sholdComponentUpdate` ç»„åˆæ‹³æ¥ä¼˜åŒ–é¿å…ç»„ä»¶é‡å¤æ¸²æŸ“ã€‚

### ç»„ä»¶ä¸ºä»€ä¹ˆä¼šè¢«é‡å¤æ¸²æŸ“ï¼Ÿ

é¦–å…ˆæ¥æ®µç¤ºä¾‹ï¼Œå½“ `App` ç»„ä»¶è§¦å‘ä¼šå½±å“ `Child` é‡æ–°æ¸²æŸ“ã€‚

```javascript
function Child() {
  console.log('Child::render');
  return <div>child</div>
}

funcction App() {
  const [data, setData] = useState(0);
  return (
    <>
      <p>{ data }</p>
      <button onClick={handleClick}>click</button>
      <Child/>
    </>
  );

  function handleClick() {
    setData(data => data + 1);
  }
}
```

**æœ‰å“ªäº›æ–¹æ³•å¯ä»¥é¿å…Childæ¸²æŸ“å‘¢ï¼Ÿ**

```javascript
const Child1 = () => {
  console.log('Child1::render');
  return <div>child</div>
}

const child1 = <Child1/>;

const Child6 = memo(() => {
  console.log('Child6::render');
  return <div>child6</div>
})

funcction App({ children, render }) {
  const [data, setData] = useState(0);
  return (
    <>
      <p>{ data }</p>
      <button onClick={handleClick}>click</button>
      { child1 }  
      { 
        useMemo(() => {
          console.log('Child2::render');
          return <div>child2</div>
        }, [])
      }
      {
        useState(() => {
          console.log('Child3::render');
          return <div>child3</div>
        })[0]
      }
      { children }
      { render }
      <Child6/>
    </>
  );

  function handleClick() {
    setData(data => data + 1);
  }
}

let child5 = () => {
    console.log('Child5::render');
    return <div>child5</div>
}

<App render={child5}>
  { React.createElement(() => {
    console.log('Chil4::render');
    return <div>child4</div>
  }) }
</App>

// é¦–æ¬¡æ¸²æŸ“
print -> star
  Child2::render
  Child3::render
  Child1::render
  Child4::render
  Child6::render
print -> end
```

é€šè¿‡ç‚¹å‡» `button` å¯ä»¥è§‚å¯Ÿåˆ°æ§åˆ¶å°å¹¶æ—  `Child` æ‰“å°å†…å®¹è¾“å‡º, å­ç»„ä»¶å¹¶æ²¡æœ‰è¢«é‡å¤æ¸²æŸ“ï¼›
ä¹Ÿå°±è¯´é™¤äº†å¸¸è§„åŒ…è£¹ `useMemo` ä¸ `memo` å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ–¹å¼ä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœï¼›
å¯èƒ½ä¼šæœ‰åŒå­¦ç–‘æƒ‘ï¼ˆåé¢ä¼šæœ‰è§£é‡Šï¼‰
- `children` ä¸æ˜¯å­èŠ‚ç‚¹å—ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰é‡æ–°æ¸²æŸ“
- `useState` ä¸ºä»€ä¹ˆä¹Ÿå¯ä»¥é¿å… `Child` æ¸²æŸ“
- æ‰“å°é¡ºåºæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ




`React` ç»„ä»¶ä¼šæ ¹æ® state(useState|setState), `props`, `context` æ¥åˆ¤æ–­å½“å‰ `fiber` æ˜¯å¦å¯ä»¥å¤ç”¨
æ‰¾åˆ°æºç ä¸­ `beginWork` æ–¹æ³•ï¼Œ
`beginWork` ä¸»è¦ç”¨äºç”Ÿæˆå­ `filber` ä»¥åŠæ‰“ä¸Šå¯¹åº” `flags`

```javascript
function beginWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
): Fiber | null {
  const updateLanes = workInProgress.lanes;
  // current å­˜åœ¨ updateæ›´æ–°
  if (current !== null) {
    const oldProps = current.memoizedProps;
    const newProps = workInProgress.pendingProps;
    // åˆ¤æ–­æ–°æ—§propsæ˜¯å¦å…¨ç­‰ æˆ–è€… ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰å˜åŒ–
    if (
      oldProps !== newProps ||
      hasLegacyContextChanged()
    ) {
      didReceiveUpdate = true;
      // å½“æ¸²æŸ“ä¼˜å…ˆçº§ä¸åŒ…å«workInProgressçš„ä¼˜å…ˆçº§ï¼Œå¤ç”¨æ—§fiber
    } else if (!includesSomeLane(renderLanes, updateLanes)) {
      didReceiveUpdate = false;
      ...
      // å¤ç”¨fiber
      return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);
    } else {
      if ((current.flags & ForceUpdateForLegacySuspense) !== NoFlags) {
        ...
        didReceiveUpdate = true;
      } else {
       ...
        didReceiveUpdate = false;
      }
    }
  } else {
    didReceiveUpdate = false;
  }

```

ä¹ä¸€çœ‹ä¸æ˜¯å¾ˆåˆç†å—ï¼Œé‚£ä¹ˆä¸ºä½•Appç»„ä»¶æ›´æ–°ä¼šå¯¼è‡´Childç»„ä»¶åˆ·æ–°å‘¢ï¼Ÿ

**é¦–å…ˆæˆ‘ä»¬å¾—çŸ¥é“workInProgress.pendingPropsåˆ°åº•æ˜¯å•¥ï¼Ÿ**
```javascript
// æºç ä¸­
const pendingProps = element.props;

// é‚£ä¹ˆè¿™ä¸ªelementåˆæ˜¯å•¥å‘¢ï¼Ÿ
// æ ¼å¼å¦‚ä¸‹
{
  _owner:null
  _store:{validated: true}
  $$typeof:Symbol(react.element)
  key:null
  props:{}
  ref:null
  type:() => {\n  console.log('Child::RENDER');\n  return /*#__PURE...
}
// æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯å¸¸å†™å¾—Jsxæ•°æ®
// å¯ä»¥æ‰“å°çœ‹çœ‹
const Child1 = () => {
  console.log('Child1::render');
  return <div>child</div>;
};

const child1 = <Child1 />;
console.log(child1);

// æ¢ä¸ªæ–¹å¼å¯ä»¥è¯æ˜
let props1 = child1.props;
let props2 = child1.props;
console.log(props1 === props2);
print -> true

// props3 ä¸ props4 ç”Ÿæˆå¾—Jsx ä¸æ˜¯åŒä¸€å¼•ç”¨å› æ­¤ä¸ç›¸ç­‰
let props3 = (<Child1 />).props;
let props4 = (<Child1 />).props;
console.log(props3 === props4);
print -> false

// è¿™ä¸ªæ¦‚å¿µç±»ä¼¼
const a = { "test": 1 };
const b = { "test": 1'};
console.log(a === b);
print -> false
const c = a; // "c" ä»…ä»…æ˜¯ "a" çš„å¼•ç”¨
console.log(a === c); 
print -> true
```

å› æ­¤å½“ `App` ç»„ä»¶æ›´æ–°æ—¶ é‡æ–°ç”Ÿæˆ `JSX`ï¼Œ`Child` ç»„ä»¶å¯¹åº”å¾— `props` å†…å­˜åœ°å€ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œæ•…ä¼šé‡æ–°æ¸²æŸ“.

è¿™ä¹Ÿå°±è§£é‡Šäº†
- åŒä¸€å¼•ç”¨å¾— `Child1` ç»„ä»¶ä¸ä¼šå—åˆ°å½±å“ã€‚
- `children` ä¸ `render` å±æ€§ä¹Ÿæ˜¯ä¸€æ ·çš„, å¼•ç”¨æœªå˜ã€‚
    - `Child5` ä¸ `Child6` ç»„ä»¶æ˜¯åœ¨ `App` å¤–éƒ¨ç”Ÿæˆçš„ `JSX` å¹¶èµ‹å€¼ç»™ `App` ä¸­çš„ `children` ä¸ `render` å±æ€§ã€‚
    - æ‰€ä»¥ `App` ç»„ä»¶å†æ¬¡æ¸²æŸ“å­ç»„ä»¶ä¾¿ä¼šé‡æ–°ç”Ÿæˆ `JSX`ï¼ˆæ¢å¥è¯è¯´åªä¼šå½±å“å†…éƒ¨çš„å­å…ƒç´ ï¼‰
    - å› ä¸º `App` å¤–å±‚æ²¡æœ‰å˜æ›´ï¼Œå› æ­¤ `App` ä¸ä¼šé‡æ–°ç”Ÿæˆ `JSX`ï¼Œ`children` ä¸ `render` å†…å­˜åœ°å€å›ºç„¶ä¸å˜å’¯ã€‚



### useMemo, memoä¸ºä½•å¯ä»¥é¿å…ç»„ä»¶é‡æ–°æ¸²æŸ“?

å¯èƒ½å¤§ä¼™éƒ½å¾ˆç†Ÿæ‚‰è¿™å‡ ä¸ª `API`ï¼Œ å¯¹äº `useMemo` ç¼“å­˜å˜é‡ï¼Œ`memo` åŒ…è£¹çš„ç»„ä»¶æµ…æ¯”è¾ƒ `props` æ¥åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ã€‚

#### memo

```javascript

// é¡¹ç›®ä¸­å¾ˆå¤šè¿™ä¹ˆä½¿ç”¨çš„(å¯èƒ½æœ‰é—®é¢˜ï¼Œä¸‹é¢ä¼šè¯´)
const Test = memo(() => <div>???</div>)
// memoè¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°â€œæ‰‹åŠ¨æ¡£â€è¿›è¡Œæ–°æ—§propsæ¯”è¾ƒ
const Test = memo(() => <div>???</div>, (prev, next) => prev !== next)

// é‚£ä¹ˆ memo æ˜¯æ€ä¹ˆä¿éšœç»„ä»¶æ¸²æŸ“çš„å‘¢
// æºç  updateMemoComponent ä¸­
const prevProps = currentChild.memoizedProps;
// compare ä¸º â€œæ‰‹åŠ¨æ¡£â€ å›è°ƒ
let compare = Component.compare;
compare = compare !== null ? compare : shallowEqual;
if (compare(prevProps, nextProps) && current.ref === workInProgress.ref) {
  // å¤ç”¨ fiber
  return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);
}
// ä¹Ÿå°±æ˜¯å­˜åœ¨å®šä¹‰çš„æ¯”è¾ƒå‡½æ•°æ—¶ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ¯”è¾ƒshallowEqual
// å‘½ä¸­åˆ™å¤ç”¨ä¸ä¼šé‡æ–°æ¸²æŸ“
```

æ‰€ä»¥è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸Šé¢ä¸ºä»€ä¹ˆè¯´ `memo` åŒ…è£¹çš„ `Child6` ä¸ä¼šè¢«é‡æ–°æ¸²æŸ“ã€‚
å†çœ‹çœ‹é»˜è®¤æ¯”è¾ƒè§„åˆ™ `shallowEqual`:
- æ¯”è¾ƒå†…å­˜
- ä¸æ˜¯å¯¹è±¡
- æ¯”è¾ƒå‚æ•°é•¿åº¦
- éå†å‚æ•°æ¯”è¾ƒ


```javascript

function shallowEqual(objA: mixed, objB: mixed): boolean {
  if (is(objA, objB)) {
    return true;
  }

  if (
    typeof objA !== 'object' ||
    objA === null ||
    typeof objB !== 'object' ||
    objB === null
  ) {
    return false;
  }

  const keysA = Object.keys(objA);
  const keysB = Object.keys(objB);

  if (keysA.length !== keysB.length) {
    return false;
  }

  // Test for A's keys different from B.
  for (let i = 0; i < keysA.length; i++) {
    if (
      !hasOwnProperty.call(objB, keysA[i]) ||
      !is(objA[keysA[i]], objB[keysA[i]])
    ) {
      return false;
    }
  }

  return true;
}
```

##### é—®: ç»™æ‰€æœ‰ç»„ä»¶éƒ½åŒ…è£¹memoåˆé€‚å—ï¼Ÿ
ä¸Šé¢å¤§å®¶éƒ½å¯ä»¥çœ‹åˆ° `memo` çš„å¥½å¤„ï¼Œä½†æ˜¯å‡¡æ˜¯éƒ½æœ‰ä»£ä»·çš„ï¼Œå¯¹æ¯”æ­£å¸¸çš„ç»„ä»¶å¤šäº†ä¸€å±‚æµ…æ¯”è¾ƒé€»è¾‘ä¸è¯´ã€‚
å¯¹äºå‚æ•°æ¯”è¾ƒå°‘çš„ç»„ä»¶æ¥è¯´ï¼Œä½¿ç”¨é»˜è®¤è§„åˆ™å¯èƒ½å¼€é”€ä¸é‚£ä¹ˆå¤§ã€‚

```javascript
// ä¸¾ä¸ªæç«¯çš„ä¾‹å­ï¼Œè¿™è¦èµ°é»˜è®¤æ¯”è¾ƒä¸å¾—è€è¦å‘½äº†ğŸ˜‰
// ä¸‹æ¬¡çœ‹åˆ°å»ºè®®ç›´æ¥æ‰“æ­»
const Demo = memo(() => <div>demo</div>)

let records = {
  ...100 arguments
}
<Demo {...records}/>
```

#### useMemo

```javascript
// useMemo ç”¨æ¥ç¼“å­˜åŸå§‹å˜é‡
// ä¸¾ä¸ªæ —å­
let originData = {
  test: '???',
};

const Test = () => {
  const [data, setData] = useState(0);
  let cacheData = useMemo(() => originData, []);
  console.log(cacheData === originData);

  return <div onClick={() => {
      setData(data => data + 1)
  }}>click</div>
}

// Test ç»„ä»¶æ¯æ¬¡æ¸²æŸ“ éƒ½ä¼šæ‰“å° true
// ä¸Šé¢è¯´äº†<Child/> å°±æ˜¯JSXå¯¹è±¡
// æ‰€ä»¥useMemoä¹Ÿèƒ½ç¼“å­˜JSXå¯¹è±¡å¼•ç”¨,  ä¿éšœæ–°æ—§propsåœ°å€ç›¸åŒ
```


##### é—®ï¼šä¸ºä»€ä¹ˆuseMemoå¯ä»¥ç¼“å­˜æ•°æ®ï¼Ÿ

å…¶å®å¯ä»¥æ ¹æ®ä¸Šé¢çš„ç¤ºä¾‹çŒœæµ‹ä¸€ä¸‹ï¼Œï¼ˆæ‰§è¡Œå›è°ƒï¼Œç¼“å­˜å›è°ƒå˜é‡ï¼Ÿï¼Ÿï¼‰
ç»†è¯´çš„è¯è¿™ä¸ªé—®é¢˜å…¶å®å’Œ `Hooks` åŸç†æ˜¯å·®ä¸å¤šçš„ã€‚

**é¦–æ¬¡æ¸²æŸ“æ—¶çš„ `useMemo`:**

```javasccript
export function useMemo<T>(
  create: () => T,
  deps: Array<mixed> | void | null,
): T {
  const dispatcher = resolveDispatcher();
  return dispatcher.useMemo(create, deps);
}
// dispatcher.useMemo æœ€ç»ˆä¼šè°ƒç”¨ mountMemo

function mountMemo<T>(
  nextCreate: () => T,
  deps: Array<mixed> | void | null,
): T {
  const hook = mountWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  const nextValue = nextCreate();
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}
// å¯ä»¥çœ‹åˆ° nextValue (ä¹Ÿå°±æ˜¯éœ€è¦ç¼“å­˜çš„å˜é‡æˆ–è€…JSXå¯¹è±¡)è¢«å­˜å…¥hook.memoizedStateä¸­



function mountWorkInProgressHook(): Hook {
  const hook: Hook = {
    memoizedState: null,

    baseState: null,
    baseQueue: null,
    queue: null,

    next: null,
  };
  // workInProgressHook è¡¨ç¤ºç»„ä»¶æ‰€åˆ›å»ºçš„hooksé“¾è¡¨
  // ä¸ºnullçš„è¯è¡¨ç¤ºå½“å‰hookæ˜¯è¯¥ç»„ä»¶çš„ç¬¬ä¸€ä¸ªhook
  if (workInProgressHook === null) {
    // This is the first hook in the list
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    // Append to the end of the list
    workInProgressHook = workInProgressHook.next = hook;
  }
  return workInProgressHook;
}
// mountWorkInProgressHook 
// åˆ›å»ºä¸€ä¸ªhook
// æ˜¯ç¬¬ä¸€ä¸ªhook, èµ‹å€¼memoizedState = workInProgressHook = hook
// ä¸æ˜¯çš„è¯å°±nextè¿æ¥èµ·æ¥
  // ä¸¾ä¸ªæ —å­
  useA(); // workInProgressHook = hookA
  useB(); // workInProgressHook = hookA.next -> hookB


//ä¸Šé¢çš„ currentlyRenderingFiber åœ¨ renderWithHooks ä¸­èµ‹å€¼ workInProgress(å½“å‰ç»„ä»¶fiber)
export function renderWithHooks<Props, SecondArg>(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) => any,
  props: Props,
  secondArg: SecondArg,
  nextRenderLanes: Lanes,
): any {
  renderLanes = nextRenderLanes;
  currentlyRenderingFiber = workInProgress;
  ...
  let children = Component(props, secondArg);
  ...
  }
```


**å†çœ‹çœ‹updateé˜¶æ®µçš„useMemo**

```javascript
// dispatcher.useMemo æœ€ç»ˆä¼šè°ƒç”¨ updateMemo
function updateMemo<T>(
  nextCreate: () => T,
  deps: Array<mixed> | void | null,
): T {
  // å½“å‰hook
  const hook = updateWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  // é¦–æ¬¡æ¸²æŸ“ç¼“å­˜çš„å€¼
  const prevState = hook.memoizedState;
  if (prevState !== null) {
    if (nextDeps !== null) {
      const prevDeps: Array<mixed> | null = prevState[1];
      // æ¯”è¾ƒä¾èµ–
      if (areHookInputsEqual(nextDeps, prevDeps)) {
        // å¤ç”¨æ—§å€¼
        return prevState[0];
      }
    }
  }
  // è®¡ç®—æ–°å€¼
  const nextValue = nextCreate();
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}
// updateMemo æ•´ä¸ªé€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„



// å†çœ‹çœ‹æ¯”è¾ƒä¾èµ–areHookInputsEqual 
function areHookInputsEqual(
  nextDeps: Array<mixed>,
  prevDeps: Array<mixed> | null,
) {
  if (prevDeps === null) {
    return false;
  }

  for (let i = 0; i < prevDeps.length && i < nextDeps.length; i++) {
    if (is(nextDeps[i], prevDeps[i])) {
      continue;
    }
    return false;
  }
  return true;
}
```

å¤§å®¶ä¹Ÿå¯ä»¥ä¸‹é¢ä¾‹å­éªŒè¯ `useMemo` å­˜å‚¨ä½ç½®ï¼Œæ§åˆ¶å°æŸ¥çœ‹ `memoizedState` ä¸­ `memo` ç¼“å­˜çš„æ•°æ®ã€‚

```javascript
function App() {
  return (
    <>
      {useMemo(() => {
        console.log('Child2::render');
        return <div>child2</div>;
      }, [])}
    </>
  );
}
let dom = document.getElementById('root')
let current = dom.__reactContainer$g605vp1tnct
console.log(current.child.memoizedState.memoizedState);
print -> [JSXå¯¹è±¡, ä¾èµ–]
```

æ‰€ä»¥å½“ `App` ç»„ä»¶å†æ¬¡æ¸²æŸ“æ—¶ï¼Œå€˜è‹¥ `useMemo` ä¾èµ–é¡¹æ²¡æœ‰å˜æ›´ï¼Œä¾¿ä¼šå¤ç”¨(ä½¿ç”¨ä¸Šæ¬¡å†…å­˜åœ°å€ï¼Œè¿›è€Œæ–°æ—§ `props` ä¹Ÿä¼šå…¨ç­‰)ã€‚

**é‚£ä¹ˆuseMemo ç›¸åŒæ•ˆæœçš„å¥½å…„å¼Ÿ â€œpureComponentsâ€ & "sholdComponentUpdate";
ä»–ä»¬çš„ä½œç”¨çœŸçš„ç›¸ç­‰å—ï¼Ÿ**


##### pureComponents

ç±»ç»„ä»¶åªéœ€è¦ç»§æ‰¿ `pureComponents` ä¾¿å¯ä»¥é¿å… `render` æ¸²æŸ“ï¼Œæ˜¯ä¸æ˜¯ç¥ä¼¼ `memo` , é‚£ä½ çŸ¥é“ä»–ä»¬çš„åŒºåˆ«å—ï¼Ÿ

```javascript
class Test extends PureComponent {

    render() {
        console.log('Testsssssssssss');
        return "Test"
    }
}

// æºç ä¸­ PureComponent å®ç°
function PureComponent(props, context, updater) {
  this.props = props;
  this.context = context;
  this.refs = emptyObject;
  this.updater = updater || ReactNoopUpdateQueue;
}

const pureComponentPrototype = (PureComponent.prototype = new ComponentDummy());
pureComponentPrototype.constructor = PureComponent;
// ç»§æ‰¿Component
Object.assign(pureComponentPrototype, Component.prototype);
// è¿™é‡Œç•™æ„ä¸€ä¸‹ isPureReactComponent æ ‡è¯†
pureComponentPrototype.isPureReactComponent = true;
```

å¯ä»¥åœ¨ `updateClassInstance` ä¸­çœ‹åˆ°å…¨è²Œï¼Œçœç•¥äº†éƒ¨åˆ†ä»£ç 
çœ‹ä¸Šå»ä»£ç é‡å¾ˆå¤šï¼Œå…¶å®æ¯ç¯é€»è¾‘å¾ˆæ¸…æ™°, ä¸»è¦ä¸º `componentDidUpdate` å’Œ `getSnapshotBeforeUpdate` æ·»åŠ æ ‡è®°
è¿”å›æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“å¸ƒå°”æ ‡è¯†ï¼ˆtrue -&gt; éœ€è¦æ¸²æŸ“ | false -&gt; å¤ç”¨ï¼‰

1. åˆ¤æ–­æ–°æ—§ `props` ä¸ `data` å†…å­˜åœ°å€æ˜¯å¦ä¸€è‡´ï¼Œä¸Šä¸‹æ–‡æ˜¯å¦å˜åŒ–
    - æ²¡æœ‰å˜åŒ–å¤ç”¨æ”¾å› `false`, ä¸ºç›¸å…³ç”Ÿå‘½å‘¨æœŸæ‰“æ·»åŠ å¯¹åº”æ ‡è¯†
1. è®¡ç®— `shouldUpdate` 
    - `shouldUpdate` ä¸º `false` æ—¶ä»£è¡¨å¤ç”¨ï¼Œä¸ºç›¸å…³ç”Ÿå‘½å‘¨æœŸæ‰“æ·»åŠ å¯¹åº”æ ‡è¯†ï¼ˆä¸ä¸Šé¢ 1-a ä¸€è‡´ï¼‰
    - `shouldUpdate` ä¸º `true` ä»£è¡¨éœ€è¦é‡æ–° `render`ï¼Œå­˜åœ¨ `componentWillUpdate` or `UNSAFE_componentWillUpdate` æ‰§è¡Œã€‚


```javascript
function updateClassInstance(
  current: Fiber,
  workInProgress: Fiber,
  ctor: any,
  newProps: any,
  renderLanes: Lanes,
): boolean {
  const instance = workInProgress.stateNode;

  const unresolvedOldProps = workInProgress.memoizedProps;
  const oldProps =
    workInProgress.type === workInProgress.elementType
      ? unresolvedOldProps
      : resolveDefaultProps(workInProgress.type, unresolvedOldProps);
  instance.props = oldProps;
  const unresolvedNewProps = workInProgress.pendingProps;

  const oldContext = instance.context;
  const contextType = ctor.contextType;
  let nextContext = emptyContextObject;
  ...

  const oldState = workInProgress.memoizedState;
  let newState = (instance.state = oldState);
  newState = workInProgress.memoizedState;

  if (
    unresolvedOldProps === unresolvedNewProps &&
    oldState === newState &&
    !hasContextChanged() &&
    !checkHasForceUpdateAfterProcessing()
  ) {
    if (typeof instance.componentDidUpdate === 'function') {
      if (
        unresolvedOldProps !== current.memoizedProps ||
        oldState !== current.memoizedState
      ) {
        workInProgress.flags |= Update;
      }
    }
    if (typeof instance.getSnapshotBeforeUpdate === 'function') {
      if (
        unresolvedOldProps !== current.memoizedProps ||
        oldState !== current.memoizedState
      ) {
        workInProgress.flags |= Snapshot;
      }
    }
    return false;
  }
  ...
  // é‡æ–°è®¡ç®— shouldUpdate
  // éœ€è¦ç•™æ„ checkShouldComponentUpdate
  const shouldUpdate =
    checkHasForceUpdateAfterProcessing() ||
    checkShouldComponentUpdate(
      workInProgress,
      ctor,
      oldProps,
      newProps,
      oldState,
      newState,
      nextContext,
    );
  // é‡æ–°æ¸²æŸ“ render 
  // å­˜åœ¨ componentWillUpdate or UNSAFE_componentWillUpdate æ‰§è¡Œ
  // ä¸º componentDidUpdate and getSnapshotBeforeUpdate æ·»åŠ æ ‡è®°
  if (shouldUpdate) {
    if (
      !hasNewLifecycles &&
      (typeof instance.UNSAFE_componentWillUpdate === 'function' ||
        typeof instance.componentWillUpdate === 'function')
    ) {
      if (typeof instance.componentWillUpdate === 'function') {
        instance.componentWillUpdate(newProps, newState, nextContext);
      }
      if (typeof instance.UNSAFE_componentWillUpdate === 'function') {
        instance.UNSAFE_componentWillUpdate(newProps, newState, nextContext);
      }
    }
    if (typeof instance.componentDidUpdate === 'function') {
      workInProgress.flags |= Update;
    }
    if (typeof instance.getSnapshotBeforeUpdate === 'function') {
      workInProgress.flags |= Snapshot;
    }
  } else {
    // å¤ç”¨
    // ä¸º componentDidUpdate and getSnapshotBeforeUpdate æ·»åŠ æ ‡è®°
    if (typeof instance.componentDidUpdate === 'function') {
      if (
        unresolvedOldProps !== current.memoizedProps ||
        oldState !== current.memoizedState
      ) {
        workInProgress.flags |= Update;
      }
    }
    if (typeof instance.getSnapshotBeforeUpdate === 'function') {
      if (
        unresolvedOldProps !== current.memoizedProps ||
        oldState !== current.memoizedState
      ) {
        workInProgress.flags |= Snapshot;
      }
    }

    workInProgress.memoizedProps = newProps;
    workInProgress.memoizedState = newState;
  }

  instance.props = newProps;
  instance.state = newState;
  instance.context = nextContext;

  return shouldUpdate;
}
```

`checkShouldComponentUpdate` ä¸­é€»è¾‘éå¸¸ç®€å•ï¼š
1. å­˜åœ¨ `shouldComponentUpdate` è°ƒç”¨ï¼ˆ`shouldComponentUpdate` ä¼˜å…ˆçº§é«˜äº `pureComponents`ï¼‰
1. å¦åˆ™åˆ¤æ–­æ˜¯å¦å¸¦æœ‰ `isPureReactComponent` æ ‡è¯†
    - ä½¿ç”¨é»˜è®¤æ¯”è¾ƒ `shallowEqual` (è€æ¼”å‘˜äº†ä¸ä¸Šé¢ `memo` ä¸€è‡´)
    - é™¤äº†æ¯”è¾ƒ `props` å¤–è¿˜ä¼šæ¯”è¾ƒ `state` æ»¡è¶³ä¸€ä¸ªæ¡ä»¶å³å¯
1. è¿”å›æ˜¯å¦æ¸²æŸ“çŠ¶æ€æ ‡è¯†ã€‚


```javasccript
function checkShouldComponentUpdate(
  workInProgress,
  ctor,
  oldProps,
  newProps,
  oldState,
  newState,
  nextContext,
) {
  const instance = workInProgress.stateNode;
  if (typeof instance.shouldComponentUpdate === 'function') {
    const shouldUpdate = instance.shouldComponentUpdate(
      newProps,
      newState,
      nextContext,
    );

    return shouldUpdate;
  }

  if (ctor.prototype && ctor.prototype.isPureReactComponent) {
    return (
      !shallowEqual(oldProps, newProps) || !shallowEqual(oldState, newState)
    );
  }

  return true;
}
```

ä¸Šé¢ä¹ŸéªŒè¯äº† `PureComponents` ä¸ `memo` çš„å·®å¼‚æ€§:
- æ¯”è¾ƒè§„åˆ™çš„å·®å¼‚æ€§
    - é™¤äº†æ¯”è¾ƒ `props` è¿˜ä¼šæ¯”è¾ƒ `state`
    - `shouldComponentUpdate` ä¼ å‚ä¸ `memo` å›è°ƒä¹Ÿä¸ç›¸åŒ
- è€Œ `shouldComponentUpdate` æ›´åƒæ˜¯ `memo` çš„ç¬¬äºŒä¸ªå›è°ƒ
    - ä¼˜å…ˆçº§é«˜äºé»˜è®¤ `shallowEqual` æ¯”è¾ƒ 

æ‰€ä»¥è¿™ä¹ˆä¸€çœ‹ `memo` åƒæ˜¯ `PureComponents` + `shouldComponentUpdate` çš„æµ“ç¼©ç‰ˆğŸ˜„ã€‚


##### shouldUpdate æ¸²æŸ“æ ‡è¯†æ˜¯æ€ä¹ˆå½±å“æ¸²æŸ“çš„ï¼Ÿ

åœ¨ `finishClassComponent` ä¸­ä¼šæ ¹æ® `shouldUpdate` æ ‡è¯†æ¥åˆ¤æ–­å¤ç”¨
è¿™ä¸ª `bailoutOnAlreadyFinishedWord` ï¼ˆä¹Ÿæ˜¯è€æ¼”å‘˜äº†ï¼Œä¸Šé¢å¤ç”¨éƒ½æœ‰å‡ºç°,ï¼Œå¤§å®¶æ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œäº†è§£ï¼Œæ­¤å¤„ä¸å±•å¼€ï¼‰å¤ç”¨ `Filber`ã€‚

```javascript
// å¼‚å¸¸
const didCaptureError = (workInProgress.flags & DidCapture) !== NoFlags;

if (!shouldUpdate && !didCaptureError) {
  if (hasContext) {
    invalidateContextProvider(workInProgress, Component, false);
  }
  // å¤ç”¨
  return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);
}
// å­˜åœ¨å¼‚å¸¸
if (
    didCaptureError &&
    typeof Component.getDerivedStateFromError !== 'function'
  ) {
    nextChildren = null;

    if (enableProfilerTimer) {
      stopProfilerTimerIfRunning(workInProgress);
    }
  } else {
      // é‡æ–° render
      nextChildren = instance.render();
  }
  ...
```

å¥½ç°åœ¨åœ¨å›æº¯ä¹‹å‰çš„é—®é¢˜:
ç»™æ‰€æœ‰çš„  `Class` ç»„ä»¶åŒ…è£¹ `PureComponents` åˆé€‚å—ï¼Ÿ
> å…¶å®ä¸ ä¸Šé¢ç»™æ‰€æœ‰ç»„ä»¶åŒ…è£¹ `memo` çš„é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œç”šè‡³ `PureComponents` é»˜è®¤æ¯”è¾ƒæŸäº›æƒ…å†µæ€§èƒ½è¿˜æ˜¯æ¯” `memo` é»˜è®¤æ¯”è¾ƒæ›´å·®ï¼Œæ¯”å¦‚100+çš„æ–°æ—§ `props` éƒ½ç›¸ç­‰æ—¶, `ä¼šéå†æ¯”è¾ƒä¸€æ¬¡ååˆä¼šéå†æ¯”è¾ƒæ–°æ—§state`, å€˜è‹¥ `state` ä¹Ÿæ˜¯100+ å‘¢ï¼ŸğŸ¤ª

#### å…¶ä»–ä¼˜åŒ–

é¡¹ç›®ä¸­ç»å¸¸å¯ä»¥çœ‹åˆ°ç»„ä»¶é‡Œå†™ç»„ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œä¸¾ä¾‹å¹¶ä¸æ˜¯è¯´è¿™æ ·å†™ä¸è¡Œï¼Œå¯¹äºæŸäº›åœºæ™¯ä¼šæœ‰æ€§èƒ½å·®å¼‚ã€‚

```javascript
const Item2 = () => {
    useEffect(() => {
        console.log('Item2 is Mount')
    }, []);
    console.log('Item2 is Render')
    return (
        <p>Item------</p>
    );
  }

function App() {
  const [data, setData] = useState(0);
  const Item = () => {
    useEffect(() => {
        console.log('Item is Mount')
    }, []);
    console.log('Item is Render')
    return (
        <p>Item------</p>
    );
  }
  
  return (
      <div>
        {
            Array.from({length: 10}).map((_, index) => <Item key={index}/>)
        }
        {
            Array.from({length: 10}).map((_, index) => <Item2 key={index}/>)
        }
        <button onClick={hanldeClick}>è«ç¢è€å­</button>
      </div>
  );
}

--------------------
æ¯å½“ç‚¹å‡»è§¦å‘Appæ›´æ–°æ—¶, æ‰“å°è¾“å‡ºå¦‚ä¸‹
click 1æ¬¡
print ->
  Item is Render
  Item2 is Render
  Item2 is Mount
click 2æ¬¡
print ->
  Item is Render
  Item2 is Render
  Item2 is Mount
  Item is Render
  Item2 is Render
  Item2 is Mount
```

æ¯å½“ç‚¹å‡»æ—¶ã€‚ä½ ä¼šå‘ç°æ¯æ¬¡ `Item` ç»„ä»¶å†…çš„ `useEffect` éƒ½ä¼šé‡æ–°æ‰§è¡Œï¼Œ è€Œ `Item2` ç»„ä»¶ä¸ä¼šè¿™æ˜¯ä¸ºä½•ï¼Ÿ
- å”‰æœ€å¼€å§‹ä¸æ˜¯è¯´ï¼Œ`App` ç»„ä»¶æ›´æ–°ï¼Œå­ç»„ä»¶çš„ `JSX` éƒ½ä¼šé‡æ–°åˆ›å»ºï¼Œå¯¼è‡´å†…å­˜åœ°å€ä¸åŒï¼Œè¿›è€Œæ¸²æŸ“å­ç»„ä»¶
    - æŒ‰ç…§è¿™ä¸ªé€»è¾‘æ¥è¯´ï¼Œ`Item` ä¸ `Item2` ç»„ä»¶ä¸åº”è¯¥ä¼šæœ‰å·®å¼‚æ‰å¯¹å‘€
- çœ‹ä¸Šå» `Item` ç»„ä»¶æ¯æ¬¡éƒ½åˆå§‹åŒ–äº†ä¸€èˆ¬ï¼Œè¿™æ˜¯ä¸ºä½•ï¼Ÿ

è¿™ä¸ªè§£é‡Šèµ·æ¥æœ‰ç‚¹éº»çƒ¦ï¼Œéœ€è¦äº†è§£ `Diff` ï¼Œ `Hooks åŸç†`ä»¥åŠ `commitæ¸²æŸ“æµ`ã€‚

åœ¨ `reconcileChildrenArray` ï¼ˆä¹Ÿå« `Array Diff`ï¼‰-&gt; `updateSlot` -&gt; `updateElement`ä¸­ å¯ä»¥æ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚

```javasript
function updateElement(
    returnFiber: Fiber,
    current: Fiber | null,
    element: ReactElement,
    lanes: Lanes,
  ): Fiber {
    if (current !== null) {
      if (
        current.elementType === element.type
      ) {
        // å…‹éš†å¤ç”¨ Fiber
        const existing = useFiber(current, element.props);
        existing.ref = coerceRef(returnFiber, current, element);
        existing.return = returnFiber;
        return existing;
      } else if (enableBlocksAPI && current.tag === Block) {
        ...
      }
    }
    // é‡æ–°åˆ›å»º Fiber
    const created = createFiberFromElement(element, returnFiber.mode, lanes);
    created.ref = coerceRef(returnFiber, current, element);
    created.return = returnFiber;
    return created;
  }
```


ä¸Šé¢åªéœ€è¦ç•™æ„ `current.elementType === element.type` 
- `current` è¡¨ç¤ºæ—§çš„ `Fiber` å•å…ƒï¼Œ `element` ä¹Ÿå°±æ˜¯æœ€å¼€å§‹ä»‹ç»è¿‡çš„ `JSX` å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªé€»è¾‘å°±è¡¨ç¤ºåˆ¤æ–­ Item ç»„ä»¶å¼•ç”¨åœ°å€ï¼Œå¦‚æœç›¸åŒå…‹éš†å¤ç”¨ `Fiber`, ä¸åŒä¾¿ä¼šæ–°å¢ `Fiber`;

- è€Œå¯¹äº `hooks` åˆ†ä¸ºä¿©ä¸ªé˜¶æ®µï¼Œé¦–æ¬¡æ¸²æŸ“åˆå§‹åŒ–åˆ›å»º `hooks` é“¾è¡¨ï¼Œä»¥åŠ `update` é˜¶æ®µç§»åŠ¨é“¾è¡¨è·å–å½“å‰æ¯ä¸ªå¯¹åº”çš„ `hook` è®¡ç®—ç»“æœã€‚è€Œ `hooks` é“¾è¡¨è¢«æŒ‚è½½åœ¨ç»„ä»¶çš„ `Fiber` ä¸Šã€‚
å› æ­¤å½“é‡æ–°åˆ›å»º `Fiber` æ—¶ï¼Œä¸Šæ¬¡åˆå§‹åŒ–çš„ `hooks` é“¾è¡¨å¹¶æ²¡æœ‰å¾—åˆ°ä¿ç•™ï¼Œè¿›è€Œ `renderWithHooks` å†æ¬¡è¿›å…¥æ‰§è¡Œ `Item` ç»„ä»¶æ—¶ï¼Œä»»ç„¶æ˜¯åˆ›å»º `Hooksé“¾è¡¨`ï¼Œ`commit` é˜¶æ®µè°ƒåº¦ ï¼ˆè¿™é‡Œåç»­æ–‡ç« ä¼šè¯´æ˜ï¼‰ã€‚

- è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ `Item` ç»„ä»¶ä¼šæ¯æ¬¡éƒ½ä¼šæ‰§è¡Œ `useEffect` å›è°ƒï¼Œè¿™é‡Œå·®å¼‚åŒ–é™¤äº†åˆ›å»º `Fiber` çš„å¼€é”€å¤–ï¼Œå¦‚æœå­˜åœ¨ `Hooks` è¿˜æœ‰ `Hooks` é“¾è¡¨æ¯æ¬¡åˆ›å»ºçš„å¼€é”€ã€‚


##### æŠŠé€»è¾‘å…¨å¥—åœ¨setDataä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

å¯èƒ½ä¼šè§‰å¾—ä¸ä¼šæœ‰å½±å“ï¼Œå› ä¸ºæ‰§è¡Œç‚¹å‡»å›è°ƒæ—¶
ä»ç‚¹å‡»åˆ°è§†å›¾æ”¹å˜æ—¶é—´ç»´åº¦ä¸ä¼šå› ä¸ºä½ å°†é€»è¾‘æŠ½ç¦»è€Œæ”¹å˜ï¼Œä¸è¿‡æ˜¯é€»è¾‘æ‰§è¡Œæ—¶æœºçš„æ”¹å˜ï¼š
- ä¸€ä¸ªæ˜¯ç‚¹å‡»å›è°ƒæ‰§è¡Œé€»è¾‘åè®¾ç½®å€¼ã€‚
- ä¸€ä¸ªæ˜¯ä¼ å…¥å›è°ƒååˆ° `renderWithHooks`ï¼Œ è°ƒç”¨ `App component`, `hooks update` è®¡ç®—å€¼çš„å·®åˆ«ã€‚ 
emmm, ä½ è¿™è¯´ç¡®å®æ²¡é”™ï¼Œå€˜è‹¥ä½ å¼€å¯äº†å¹¶å‘æ¨¡å¼ï¼Œé‚£ä¾¿ä¼šæœ‰å·®å¼‚äº†ï¼ˆå¯ä»¥æƒ³æƒ³ï¼‰


```javascript
// ä¸¾ä¸ªæ —å­
// å¦‚æœä¸€ä¸ªhooks æœ‰å¤šä¸ªupdate å•å…ƒ
// è¿™é‡Œçš„lang è¡¨ç¤ºä¼˜å…ˆçº§, action è¡¨ç¤ºå¯¹åº”éœ€è¦è®¡ç®—çš„å€¼
hooks -> queue -> 
              update1 -> update2 ->             update3
              lang=3     lang=1                 lang=3
              action=1   action=(d) => d + 1    action=(d) => 100+more

// å¯ä»¥çœ‹åˆ° update3 ä¸ºé€»è¾‘å›è°ƒ 
// å‡è®¾å½“å‰æ¸²æŸ“ä¼˜å…ˆçº§ä¸º3, é‚£ä¹ˆæœ¬æ¬¡æ»¡è¶³æ¡ä»¶åº”è¯¥æ‰§è¡Œçš„æ˜¯ update1 + update3

éå†updateé“¾è¡¨
update1 -> update2 -> update3
  1
  ^
update1æ»¡è¶³æ¸²æŸ“æ¡ä»¶
newState = 1;
newBaseState = 1;

update1 -> update2 -> update3
            d => d + 1
              ^
update2ä¸æ»¡è¶³æ¸²æŸ“æ¡ä»¶
baseFirst = update2
newState = 1;
newBaseState = 1;


update1 -> update2 -> update3
                      d => 100more
                        ^
update3æ»¡è¶³æ¸²æŸ“æ¡ä»¶
baseFirst = update2 -> update3
newState = (1) => 100more çš„ç»“æœ;
newBaseState = 1;

é‚£ä¹ˆé¡µé¢ä¸Šdataä¼šæš‚æ—¶å±•ç¤º newStateçš„ç»“æœã€‚
ä¸‹æ¬¡æ›´æ–°ä¼šæ‰§è¡Œä¸Šæ¬¡è·³è¿‡çš„é“¾è¡¨ä»¥newBaseStateä¸ºåŸºå‡†, baseFirstï¼ˆupdate2 -> update3ï¼‰
å› æ­¤ä½ ä¼šå‘ç°ï¼Œupdate3 è¿™ä¸ªé€»è¾‘å›è°ƒå•å…ƒè¢«æ‰§è¡Œè®¡ç®—äº†ä¿©æ¬¡
```

è‡³äºhooksé“¾è¡¨è®¡ç®—è¯¦ç»†æµç¨‹æœ‰æœºä¼šåç»­æ–‡ç« è¡¥å……ğŸ˜


#### useContent ä¸æ­£å½“ä½¿ç”¨

è¿™é‡Œç»™ä¸ªç»“è®ºï¼Œå…·ä½“å‚è€ƒ `useContent` ç« èŠ‚;
å½“ä¸Šä¸‹æ–‡æ›´æ–°æ—¶ä¼šé¢å¤–æ·±åº¦ä¼˜å…ˆéå† `Fiber` åŒ¹é…æ¶ˆè´¹è€…çš„ `Context`, å› æ­¤å½“ `Provider` åµŒå¥—çš„å†…å®¹è¶Šå¤šï¼ˆæ¯”å¦‚æ ¹å…ƒç´ ä¸Šï¼‰ï¼Œéå†çš„æˆæœ¬å°±è¶Šé«˜ï¼›ç»„ä»¶å†…è€¦åˆä½¿ç”¨æ›´ä¸ºåˆé€‚ã€‚


**é‚£ä¹ˆæœ‰ä»€ä¹ˆåˆé€‚çš„æ–¹å¼å¤§èŒƒå›´ä¼ å€¼å‘¢?**

ç”¨è¿‡ `Vue` çš„åŒå­¦éƒ½çŸ¥é“ `MVVM` çš„åŸç†ï¼Œå¯¹å±æ€§è¿›è¡ŒåŠ«æŒï¼Œåœ¨ `VNode` åˆ›å»ºé˜¶æ®µè·å–å±æ€§ï¼Œä¸ºå…¶æ·»åŠ å¯¹åº”ç»„ä»¶çš„ `updateComponent`ï¼Œå±æ€§æ›´æ–° `setter` è°ƒåº¦ä»»åŠ¡æ‰§è¡Œ `updateComponent` åˆ›å»º `VNode Tree` æ¯”è¾ƒæ›´æ–°è§†å›¾ã€‚

é€šè¿‡ç»“åˆ `Proxy`ï¼Œ å°±å¯ä»¥å†çŠ¶æ€å˜æ›´æ—¶æ”¶é›†æ‰€æœ‰çš„æ¶ˆè´¹è€…ï¼Œæ‰¹é‡æ›´æ–° ï¼ˆå¸‚é¢ä¸Šä¹Ÿæœ‰ç›¸å…³çš„åº“è‡ªè¡Œäº†è§£ï¼‰ã€‚



**å°demo**

```javascript
function Store(data) {
    this.data = data;
    let id = 1;
    let promise = Promise.resolve();
    let lineComponent = null;
    this.forceUpdate = null;
    let updateMap = null;
    let proxy = new Proxy(data, {
      get(obj, prop) {
        if (componentMap) {
            if (componentMap.has(lineComponent)) {
                let list = componentMap.get(lineComponent);
                list.add(prop);
            } else {
                componentMap.set(lineComponent, new Set([prop]));
            }
        }
        
        return obj[prop];
      },
      set: (target, key, value) => {
        if (target[key] != value && updateMap) {
            updateMap.set(key, [target[key], value])
            target[key] = value;
        }
        return true;
        }
    });
    let componentMap = new Map();

    this.useUpdate = function useUpdate() {
        let [_, set] = React.useState(0);
        this.forceUpdate = () => set(a => a + 1);
        return (key, val) => {
            updateMap = new Map();
            proxy[key] = val;
            promise.then(this.forceUpdate);
        };
    }
  
    this.useStore = function(cb) {
      return cb(proxy);
    }
    this.Provider = function Provider({ value, children }) {
      return (
        <>
          { children }
        </>
      );
    }
    
    let defaultEqual = function(equal, prev, next) {
        let list = componentMap.get(lineComponent) || [];
        
        for (let i of list) {
            if (updateMap && updateMap.has(i)) {
                return false;
            }
        }
        if (equal) {
            return equal(prev, next);
        }

        for (let i in next) {
            if (Object.is(next[i], prev[i])) {
                continue;
            }
            return false
        }
        return true;
    }
    this.Component = (callback, equal) => {
      id+=1;
      lineComponent = null;
      let JSX = React.memo(callback, defaultEqual.bind(null, equal));
      lineComponent = JSX.type;
      return JSX;
    }
  }
```


ä½¿ç”¨

```javascript
let store = new Store({
  name: 'wujie',
  age: '2-'
})

const Demo = store.Component(() => {
    let { name, age } = store.useStore((data) => ({
        name: data.name,
        age: data.age
    }));
    let set = store.useUpdate();
    return (
        <div onClick={() => {
            set('name',11)
            set('name',33)
            set('age',50)
        }}>data --- { name }--{age}</div>
    );
})

const root = (
    <store.Provider>
        {
            React.createElement(() => {
                let [a, b] = React.useState(0);
                console.log('render.....')
                return (
                    <div>
                        <p onClick={() => b(a + 1)}>a---{a}</p>
                        <Demo/>
                    </div>
                );
            })
        }
    </store.Provider>
)
```

