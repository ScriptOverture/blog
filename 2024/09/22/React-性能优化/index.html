<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>React æ€§èƒ½ä¼˜åŒ– &mdash; overture</title><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/components/collection.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/globals/common.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/css/posts/index.css"><link rel="stylesheet" href="https://scriptoverture.github.io/blog/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="https://scriptoverture.github.io/blog/2024/09/22/React-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><link rel="alternate" type="application/atom+xml" title="overture" href="https://scriptoverture.github.io/blog/feed.xml"><link rel="shortcut icon" href="https://scriptoverture.github.io/blog/favicon.ico"><meta property="og:title" content="React æ€§èƒ½ä¼˜åŒ–"><meta name="keywords" content="React, æ€§èƒ½"><meta name="og:keywords" content="React, æ€§èƒ½"><meta name="description" content="ç†Ÿæ‚‰ React çš„åŒå­¦ä»¬éƒ½çŸ¥é“ï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°éƒ½ä¼šé‡æ–°æ¸²æŸ“ fiber æ ‘ï¼ŒåŒ¹é…æ¸²æŸ“ä¼˜å…ˆçº§ç»„ä»¶åŠå…¶æ‰€æœ‰å­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œå­˜åœ¨å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¯èƒ½å¼€å‘ä¸­å¾ˆå¤šåŒå­¦ä¼šæå‡º useMemoï¼ŒuseCallback, memo, pureComponent, sholdComponentUpdate ç»„åˆæ‹³æ¥ä¼˜åŒ–é¿å…ç»„ä»¶é‡å¤æ¸²æŸ“ã€‚"><meta name="og:description" content="ç†Ÿæ‚‰ React çš„åŒå­¦ä»¬éƒ½çŸ¥é“ï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°éƒ½ä¼šé‡æ–°æ¸²æŸ“ fiber æ ‘ï¼ŒåŒ¹é…æ¸²æŸ“ä¼˜å…ˆçº§ç»„ä»¶åŠå…¶æ‰€æœ‰å­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œå­˜åœ¨å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¯èƒ½å¼€å‘ä¸­å¾ˆå¤šåŒå­¦ä¼šæå‡º useMemoï¼ŒuseCallback, memo, pureComponent, sholdComponentUpdate ç»„åˆæ‹³æ¥ä¼˜åŒ–é¿å…ç»„ä»¶é‡å¤æ¸²æŸ“ã€‚"><meta property="og:url" content="https://scriptoverture.github.io/blog/2024/09/22/React-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><meta property="og:site_name" content="overture"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2024-09-22"> <script src="https://scriptoverture.github.io/blog/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://scriptoverture.github.io/blog/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6VKGSE98P"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Z6VKGSE98P'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://scriptoverture.github.io/blog/" title="overture"><span class="octicon octicon-mark-github"></span> overture</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://scriptoverture.github.io/blog/" class="site-header-nav-item" target="" title="é¦–é¡µ">é¦–é¡µ</a> <a href="https://scriptoverture.github.io/blog/categories/" class="site-header-nav-item" target="" title="åˆ†ç±»">åˆ†ç±»</a> <a href="https://scriptoverture.github.io/blog/archives/" class="mobile-hidden site-header-nav-item" target="" title="å½’æ¡£">å½’æ¡£</a> <a href="https://scriptoverture.github.io/blog/open-source/" class="mobile-hidden site-header-nav-item" target="" title="å¼€æº">å¼€æº</a> <a href="https://scriptoverture.github.io/blog/fragments/" class="site-header-nav-item" target="" title="ç‰‡æ®µ">ç‰‡æ®µ</a> <a href="https://scriptoverture.github.io/blog/wiki/" class="site-header-nav-item" target="" title="ç»´åŸº">ç»´åŸº</a> <a href="https://scriptoverture.github.io/blog/links/" class="mobile-hidden site-header-nav-item" target="" title="é“¾æ¥">é“¾æ¥</a> <a href="https://scriptoverture.github.io/blog/about/" class="site-header-nav-item" target="" title="å…³äº">å…³äº</a> <a class="mobile-hidden" href="https://scriptoverture.github.io/blog/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="React æ€§èƒ½ä¼˜åŒ–"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">React æ€§èƒ½ä¼˜åŒ–</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2024/09/22 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://scriptoverture.github.io/blog/categories/#React" title="React">React</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> å…± 18299 å­—ï¼Œçº¦ 53 åˆ†é’Ÿ </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>ç†Ÿæ‚‰ <code class="language-plaintext highlighter-rouge">React</code> çš„åŒå­¦ä»¬éƒ½çŸ¥é“ï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°éƒ½ä¼šé‡æ–°æ¸²æŸ“ <code class="language-plaintext highlighter-rouge">fiber</code> æ ‘ï¼ŒåŒ¹é…æ¸²æŸ“ä¼˜å…ˆçº§ç»„ä»¶åŠå…¶æ‰€æœ‰å­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œå­˜åœ¨å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¯èƒ½å¼€å‘ä¸­å¾ˆå¤šåŒå­¦ä¼šæå‡º <code class="language-plaintext highlighter-rouge">useMemo</code>ï¼Œ<code class="language-plaintext highlighter-rouge">useCallback</code>, <code class="language-plaintext highlighter-rouge">memo</code>, <code class="language-plaintext highlighter-rouge">pureComponent</code>, <code class="language-plaintext highlighter-rouge">sholdComponentUpdate</code> ç»„åˆæ‹³æ¥ä¼˜åŒ–é¿å…ç»„ä»¶é‡å¤æ¸²æŸ“ã€‚</p><h3 id="ç»„ä»¶ä¸ºä»€ä¹ˆä¼šè¢«é‡å¤æ¸²æŸ“">ç»„ä»¶ä¸ºä»€ä¹ˆä¼šè¢«é‡å¤æ¸²æŸ“ï¼Ÿ</h3><p>é¦–å…ˆæ¥æ®µç¤ºä¾‹ï¼Œå½“ <code class="language-plaintext highlighter-rouge">App</code> ç»„ä»¶è§¦å‘ä¼šå½±å“ <code class="language-plaintext highlighter-rouge">Child</code> é‡æ–°æ¸²æŸ“ã€‚</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Child</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child::render</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="p">}</span>

<span class="nx">funcction</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">data</span><span class="p">,</span> <span class="nx">setData</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;&gt;</span>
      <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span> <span class="nx">data</span> <span class="p">}</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleClick</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">click</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">Child</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="sr">/</span><span class="err">&gt;
</span>  <span class="p">);</span>

  <span class="kd">function</span> <span class="nx">handleClick</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">setData</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p><strong>æœ‰å“ªäº›æ–¹æ³•å¯ä»¥é¿å…Childæ¸²æŸ“å‘¢ï¼Ÿ</strong></p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Child1</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child1::render</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="p">}</span>

<span class="kd">const</span> <span class="nx">child1</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">Child1</span><span class="o">/&gt;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">Child6</span> <span class="o">=</span> <span class="nx">memo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child6::render</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child6</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="p">})</span>

<span class="nx">funcction</span> <span class="nx">App</span><span class="p">({</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">render</span> <span class="p">})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">data</span><span class="p">,</span> <span class="nx">setData</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;&gt;</span>
      <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span> <span class="nx">data</span> <span class="p">}</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleClick</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">click</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="p">{</span> <span class="nx">child1</span> <span class="p">}</span>  
      <span class="p">{</span> 
        <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child2::render</span><span class="dl">'</span><span class="p">);</span>
          <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child2</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="p">},</span> <span class="p">[])</span>
      <span class="p">}</span>
      <span class="p">{</span>
        <span class="nx">useState</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child3::render</span><span class="dl">'</span><span class="p">);</span>
          <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child3</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
      <span class="p">}</span>
      <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
      <span class="p">{</span> <span class="nx">render</span> <span class="p">}</span>
      <span class="o">&lt;</span><span class="nx">Child6</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="sr">/</span><span class="err">&gt;
</span>  <span class="p">);</span>

  <span class="kd">function</span> <span class="nx">handleClick</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">setData</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">child5</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child5::render</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child5</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="p">}</span>

<span class="o">&lt;</span><span class="nx">App</span> <span class="nx">render</span><span class="o">=</span><span class="p">{</span><span class="nx">child5</span><span class="p">}</span><span class="o">&gt;</span>
  <span class="p">{</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Chil4::render</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child4</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">})</span> <span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/App</span><span class="err">&gt;
</span>
<span class="c1">// é¦–æ¬¡æ¸²æŸ“</span>
<span class="nx">print</span> <span class="o">-&gt;</span> <span class="nx">star</span>
  <span class="nx">Child2</span><span class="p">::</span><span class="nx">render</span>
  <span class="nx">Child3</span><span class="p">::</span><span class="nx">render</span>
  <span class="nx">Child1</span><span class="p">::</span><span class="nx">render</span>
  <span class="nx">Child4</span><span class="p">::</span><span class="nx">render</span>
  <span class="nx">Child6</span><span class="p">::</span><span class="nx">render</span>
<span class="nx">print</span> <span class="o">-&gt;</span> <span class="nx">end</span>
</code></pre></div></div><p>é€šè¿‡ç‚¹å‡» <code class="language-plaintext highlighter-rouge">button</code> å¯ä»¥è§‚å¯Ÿåˆ°æ§åˆ¶å°å¹¶æ—  <code class="language-plaintext highlighter-rouge">Child</code> æ‰“å°å†…å®¹è¾“å‡º, å­ç»„ä»¶å¹¶æ²¡æœ‰è¢«é‡å¤æ¸²æŸ“ï¼› ä¹Ÿå°±è¯´é™¤äº†å¸¸è§„åŒ…è£¹ <code class="language-plaintext highlighter-rouge">useMemo</code> ä¸ <code class="language-plaintext highlighter-rouge">memo</code> å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ–¹å¼ä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœï¼› å¯èƒ½ä¼šæœ‰åŒå­¦ç–‘æƒ‘ï¼ˆåé¢ä¼šæœ‰è§£é‡Šï¼‰</p><ul><li><code class="language-plaintext highlighter-rouge">children</code> ä¸æ˜¯å­èŠ‚ç‚¹å—ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰é‡æ–°æ¸²æŸ“</li><li><code class="language-plaintext highlighter-rouge">useState</code> ä¸ºä»€ä¹ˆä¹Ÿå¯ä»¥é¿å… <code class="language-plaintext highlighter-rouge">Child</code> æ¸²æŸ“</li><li>æ‰“å°é¡ºåºæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</li></ul><p><code class="language-plaintext highlighter-rouge">React</code> ç»„ä»¶ä¼šæ ¹æ® state(useState|setState), <code class="language-plaintext highlighter-rouge">props</code>, <code class="language-plaintext highlighter-rouge">context</code> æ¥åˆ¤æ–­å½“å‰ <code class="language-plaintext highlighter-rouge">fiber</code> æ˜¯å¦å¯ä»¥å¤ç”¨ æ‰¾åˆ°æºç ä¸­ <code class="language-plaintext highlighter-rouge">beginWork</code> æ–¹æ³•ï¼Œ <code class="language-plaintext highlighter-rouge">beginWork</code> ä¸»è¦ç”¨äºç”Ÿæˆå­ <code class="language-plaintext highlighter-rouge">filber</code> ä»¥åŠæ‰“ä¸Šå¯¹åº” <code class="language-plaintext highlighter-rouge">flags</code></p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">beginWork</span><span class="p">(</span>
  <span class="nx">current</span><span class="p">:</span> <span class="nx">Fiber</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">workInProgress</span><span class="p">:</span> <span class="nx">Fiber</span><span class="p">,</span>
  <span class="nx">renderLanes</span><span class="p">:</span> <span class="nx">Lanes</span><span class="p">,</span>
<span class="p">):</span> <span class="nx">Fiber</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">updateLanes</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">lanes</span><span class="p">;</span>
  <span class="c1">// current å­˜åœ¨ updateæ›´æ–°</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">current</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">oldProps</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedProps</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">newProps</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">pendingProps</span><span class="p">;</span>
    <span class="c1">// åˆ¤æ–­æ–°æ—§propsæ˜¯å¦å…¨ç­‰ æˆ–è€… ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰å˜åŒ–</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">oldProps</span> <span class="o">!==</span> <span class="nx">newProps</span> <span class="o">||</span>
      <span class="nx">hasLegacyContextChanged</span><span class="p">()</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nx">didReceiveUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// å½“æ¸²æŸ“ä¼˜å…ˆçº§ä¸åŒ…å«workInProgressçš„ä¼˜å…ˆçº§ï¼Œå¤ç”¨æ—§fiber</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">includesSomeLane</span><span class="p">(</span><span class="nx">renderLanes</span><span class="p">,</span> <span class="nx">updateLanes</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">didReceiveUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">...</span>
      <span class="c1">// å¤ç”¨fiber</span>
      <span class="k">return</span> <span class="nx">bailoutOnAlreadyFinishedWork</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">workInProgress</span><span class="p">,</span> <span class="nx">renderLanes</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">current</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="nx">ForceUpdateForLegacySuspense</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">NoFlags</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="nx">didReceiveUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="p">...</span>
        <span class="nx">didReceiveUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">didReceiveUpdate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

</code></pre></div></div><p>ä¹ä¸€çœ‹ä¸æ˜¯å¾ˆåˆç†å—ï¼Œé‚£ä¹ˆä¸ºä½•Appç»„ä»¶æ›´æ–°ä¼šå¯¼è‡´Childç»„ä»¶åˆ·æ–°å‘¢ï¼Ÿ</p><p><strong>é¦–å…ˆæˆ‘ä»¬å¾—çŸ¥é“workInProgress.pendingPropsåˆ°åº•æ˜¯å•¥ï¼Ÿ</strong></p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æºç ä¸­</span>
<span class="kd">const</span> <span class="nx">pendingProps</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>

<span class="c1">// é‚£ä¹ˆè¿™ä¸ªelementåˆæ˜¯å•¥å‘¢ï¼Ÿ</span>
<span class="c1">// æ ¼å¼å¦‚ä¸‹</span>
<span class="p">{</span>
  <span class="na">_owner</span><span class="p">:</span><span class="kc">null</span>
  <span class="na">_store</span><span class="p">:{</span><span class="na">validated</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
  <span class="nx">$</span><span class="na">$typeof</span><span class="p">:</span><span class="nb">Symbol</span><span class="p">(</span><span class="nx">react</span><span class="p">.</span><span class="nx">element</span><span class="p">)</span>
  <span class="na">key</span><span class="p">:</span><span class="kc">null</span>
  <span class="na">props</span><span class="p">:{}</span>
  <span class="nl">ref</span><span class="p">:</span><span class="kc">null</span>
  <span class="na">type</span><span class="p">:()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="err">\</span><span class="nx">n</span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child::RENDER</span><span class="dl">'</span><span class="p">);</span><span class="err">\</span><span class="nx">n</span>  <span class="k">return</span> <span class="cm">/*#__PURE...
}
// æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯å¸¸å†™å¾—Jsxæ•°æ®
// å¯ä»¥æ‰“å°çœ‹çœ‹
const Child1 = () =&gt; {
  console.log('Child1::render');
  return &lt;div&gt;child&lt;/div&gt;;
};

const child1 = &lt;Child1 /&gt;;
console.log(child1);

// æ¢ä¸ªæ–¹å¼å¯ä»¥è¯æ˜
let props1 = child1.props;
let props2 = child1.props;
console.log(props1 === props2);
print -&gt; true

// props3 ä¸ props4 ç”Ÿæˆå¾—Jsx ä¸æ˜¯åŒä¸€å¼•ç”¨å› æ­¤ä¸ç›¸ç­‰
let props3 = (&lt;Child1 /&gt;).props;
let props4 = (&lt;Child1 /&gt;).props;
console.log(props3 === props4);
print -&gt; false

// è¿™ä¸ªæ¦‚å¿µç±»ä¼¼
const a = { "test": 1 };
const b = { "test": 1'};
console.log(a === b);
print -&gt; false
const c = a; // "c" ä»…ä»…æ˜¯ "a" çš„å¼•ç”¨
console.log(a === c); 
print -&gt; true
</span></code></pre></div></div><p>å› æ­¤å½“ <code class="language-plaintext highlighter-rouge">App</code> ç»„ä»¶æ›´æ–°æ—¶ é‡æ–°ç”Ÿæˆ <code class="language-plaintext highlighter-rouge">JSX</code>ï¼Œ<code class="language-plaintext highlighter-rouge">Child</code> ç»„ä»¶å¯¹åº”å¾— <code class="language-plaintext highlighter-rouge">props</code> å†…å­˜åœ°å€ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œæ•…ä¼šé‡æ–°æ¸²æŸ“.</p><p>è¿™ä¹Ÿå°±è§£é‡Šäº†</p><ul><li>åŒä¸€å¼•ç”¨å¾— <code class="language-plaintext highlighter-rouge">Child1</code> ç»„ä»¶ä¸ä¼šå—åˆ°å½±å“ã€‚</li><li><code class="language-plaintext highlighter-rouge">children</code> ä¸ <code class="language-plaintext highlighter-rouge">render</code> å±æ€§ä¹Ÿæ˜¯ä¸€æ ·çš„, å¼•ç”¨æœªå˜ã€‚<ul><li><code class="language-plaintext highlighter-rouge">Child5</code> ä¸ <code class="language-plaintext highlighter-rouge">Child6</code> ç»„ä»¶æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">App</code> å¤–éƒ¨ç”Ÿæˆçš„ <code class="language-plaintext highlighter-rouge">JSX</code> å¹¶èµ‹å€¼ç»™ <code class="language-plaintext highlighter-rouge">App</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">children</code> ä¸ <code class="language-plaintext highlighter-rouge">render</code> å±æ€§ã€‚</li><li>æ‰€ä»¥ <code class="language-plaintext highlighter-rouge">App</code> ç»„ä»¶å†æ¬¡æ¸²æŸ“å­ç»„ä»¶ä¾¿ä¼šé‡æ–°ç”Ÿæˆ <code class="language-plaintext highlighter-rouge">JSX</code>ï¼ˆæ¢å¥è¯è¯´åªä¼šå½±å“å†…éƒ¨çš„å­å…ƒç´ ï¼‰</li><li>å› ä¸º <code class="language-plaintext highlighter-rouge">App</code> å¤–å±‚æ²¡æœ‰å˜æ›´ï¼Œå› æ­¤ <code class="language-plaintext highlighter-rouge">App</code> ä¸ä¼šé‡æ–°ç”Ÿæˆ <code class="language-plaintext highlighter-rouge">JSX</code>ï¼Œ<code class="language-plaintext highlighter-rouge">children</code> ä¸ <code class="language-plaintext highlighter-rouge">render</code> å†…å­˜åœ°å€å›ºç„¶ä¸å˜å’¯ã€‚</li></ul></li></ul><h3 id="usememo-memoä¸ºä½•å¯ä»¥é¿å…ç»„ä»¶é‡æ–°æ¸²æŸ“">useMemo, memoä¸ºä½•å¯ä»¥é¿å…ç»„ä»¶é‡æ–°æ¸²æŸ“?</h3><p>å¯èƒ½å¤§ä¼™éƒ½å¾ˆç†Ÿæ‚‰è¿™å‡ ä¸ª <code class="language-plaintext highlighter-rouge">API</code>ï¼Œ å¯¹äº <code class="language-plaintext highlighter-rouge">useMemo</code> ç¼“å­˜å˜é‡ï¼Œ<code class="language-plaintext highlighter-rouge">memo</code> åŒ…è£¹çš„ç»„ä»¶æµ…æ¯”è¾ƒ <code class="language-plaintext highlighter-rouge">props</code> æ¥åˆ¤æ–­ç»„ä»¶æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ã€‚</p><h4 id="memo">memo</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// é¡¹ç›®ä¸­å¾ˆå¤šè¿™ä¹ˆä½¿ç”¨çš„(å¯èƒ½æœ‰é—®é¢˜ï¼Œä¸‹é¢ä¼šè¯´)</span>
<span class="kd">const</span> <span class="nx">Test</span> <span class="o">=</span> <span class="nx">memo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;??</span><span class="p">?</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">)
</span><span class="c1">// memoè¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°â€œæ‰‹åŠ¨æ¡£â€è¿›è¡Œæ–°æ—§propsæ¯”è¾ƒ</span>
<span class="kd">const</span> <span class="nx">Test</span> <span class="o">=</span> <span class="nx">memo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;??</span><span class="p">?</span><span class="o">&lt;</span><span class="sr">/div&gt;, </span><span class="se">(</span><span class="sr">prev, next</span><span class="se">)</span><span class="sr"> =&gt; prev !== next</span><span class="err">)
</span>
<span class="c1">// é‚£ä¹ˆ memo æ˜¯æ€ä¹ˆä¿éšœç»„ä»¶æ¸²æŸ“çš„å‘¢</span>
<span class="c1">// æºç  updateMemoComponent ä¸­</span>
<span class="kd">const</span> <span class="nx">prevProps</span> <span class="o">=</span> <span class="nx">currentChild</span><span class="p">.</span><span class="nx">memoizedProps</span><span class="p">;</span>
<span class="c1">// compare ä¸º â€œæ‰‹åŠ¨æ¡£â€ å›è°ƒ</span>
<span class="kd">let</span> <span class="nx">compare</span> <span class="o">=</span> <span class="nx">Component</span><span class="p">.</span><span class="nx">compare</span><span class="p">;</span>
<span class="nx">compare</span> <span class="o">=</span> <span class="nx">compare</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">?</span> <span class="nx">compare</span> <span class="p">:</span> <span class="nx">shallowEqual</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">compare</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span><span class="p">.</span><span class="nx">ref</span> <span class="o">===</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// å¤ç”¨ fiber</span>
  <span class="k">return</span> <span class="nx">bailoutOnAlreadyFinishedWork</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">workInProgress</span><span class="p">,</span> <span class="nx">renderLanes</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ä¹Ÿå°±æ˜¯å­˜åœ¨å®šä¹‰çš„æ¯”è¾ƒå‡½æ•°æ—¶ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ¯”è¾ƒshallowEqual</span>
<span class="c1">// å‘½ä¸­åˆ™å¤ç”¨ä¸ä¼šé‡æ–°æ¸²æŸ“</span>
</code></pre></div></div><p>æ‰€ä»¥è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸Šé¢ä¸ºä»€ä¹ˆè¯´ <code class="language-plaintext highlighter-rouge">memo</code> åŒ…è£¹çš„ <code class="language-plaintext highlighter-rouge">Child6</code> ä¸ä¼šè¢«é‡æ–°æ¸²æŸ“ã€‚ å†çœ‹çœ‹é»˜è®¤æ¯”è¾ƒè§„åˆ™ <code class="language-plaintext highlighter-rouge">shallowEqual</code>:</p><ul><li>æ¯”è¾ƒå†…å­˜</li><li>ä¸æ˜¯å¯¹è±¡</li><li>æ¯”è¾ƒå‚æ•°é•¿åº¦</li><li>éå†å‚æ•°æ¯”è¾ƒ</li></ul><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">function</span> <span class="nx">shallowEqual</span><span class="p">(</span><span class="nx">objA</span><span class="p">:</span> <span class="nx">mixed</span><span class="p">,</span> <span class="nx">objB</span><span class="p">:</span> <span class="nx">mixed</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">is</span><span class="p">(</span><span class="nx">objA</span><span class="p">,</span> <span class="nx">objB</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span>
    <span class="k">typeof</span> <span class="nx">objA</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span> <span class="o">||</span>
    <span class="nx">objA</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span>
    <span class="k">typeof</span> <span class="nx">objB</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span> <span class="o">||</span>
    <span class="nx">objB</span> <span class="o">===</span> <span class="kc">null</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">keysA</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">objA</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">keysB</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">objB</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">keysA</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">keysB</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Test for A's keys different from B.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keysA</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">objB</span><span class="p">,</span> <span class="nx">keysA</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">||</span>
      <span class="o">!</span><span class="nx">is</span><span class="p">(</span><span class="nx">objA</span><span class="p">[</span><span class="nx">keysA</span><span class="p">[</span><span class="nx">i</span><span class="p">]],</span> <span class="nx">objB</span><span class="p">[</span><span class="nx">keysA</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><h5 id="é—®-ç»™æ‰€æœ‰ç»„ä»¶éƒ½åŒ…è£¹memoåˆé€‚å—">é—®: ç»™æ‰€æœ‰ç»„ä»¶éƒ½åŒ…è£¹memoåˆé€‚å—ï¼Ÿ</h5><p>ä¸Šé¢å¤§å®¶éƒ½å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">memo</code> çš„å¥½å¤„ï¼Œä½†æ˜¯å‡¡æ˜¯éƒ½æœ‰ä»£ä»·çš„ï¼Œå¯¹æ¯”æ­£å¸¸çš„ç»„ä»¶å¤šäº†ä¸€å±‚æµ…æ¯”è¾ƒé€»è¾‘ä¸è¯´ã€‚ å¯¹äºå‚æ•°æ¯”è¾ƒå°‘çš„ç»„ä»¶æ¥è¯´ï¼Œä½¿ç”¨é»˜è®¤è§„åˆ™å¯èƒ½å¼€é”€ä¸é‚£ä¹ˆå¤§ã€‚</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¸¾ä¸ªæç«¯çš„ä¾‹å­ï¼Œè¿™è¦èµ°é»˜è®¤æ¯”è¾ƒä¸å¾—è€è¦å‘½äº†ğŸ˜‰</span>
<span class="c1">// ä¸‹æ¬¡çœ‹åˆ°å»ºè®®ç›´æ¥æ‰“æ­»</span>
<span class="kd">const</span> <span class="nx">Demo</span> <span class="o">=</span> <span class="nx">memo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">demo</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">)
</span>
<span class="kd">let</span> <span class="nx">records</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">...</span><span class="mi">100</span> <span class="nx">arguments</span>
<span class="p">}</span>
<span class="o">&lt;</span><span class="nx">Demo</span> <span class="p">{...</span><span class="nx">records</span><span class="p">}</span><span class="sr">/</span><span class="err">&gt;
</span></code></pre></div></div><h4 id="usememo">useMemo</h4><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// useMemo ç”¨æ¥ç¼“å­˜åŸå§‹å˜é‡</span>
<span class="c1">// ä¸¾ä¸ªæ —å­</span>
<span class="kd">let</span> <span class="nx">originData</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">test</span><span class="p">:</span> <span class="dl">'</span><span class="s1">???</span><span class="dl">'</span><span class="p">,</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">Test</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">data</span><span class="p">,</span> <span class="nx">setData</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">cacheData</span> <span class="o">=</span> <span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">originData</span><span class="p">,</span> <span class="p">[]);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cacheData</span> <span class="o">===</span> <span class="nx">originData</span><span class="p">);</span>

  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">setData</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">}}</span><span class="o">&gt;</span><span class="nx">click</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="p">}</span>

<span class="c1">// Test ç»„ä»¶æ¯æ¬¡æ¸²æŸ“ éƒ½ä¼šæ‰“å° true</span>
<span class="c1">// ä¸Šé¢è¯´äº†&lt;Child/&gt; å°±æ˜¯JSXå¯¹è±¡</span>
<span class="c1">// æ‰€ä»¥useMemoä¹Ÿèƒ½ç¼“å­˜JSXå¯¹è±¡å¼•ç”¨,  ä¿éšœæ–°æ—§propsåœ°å€ç›¸åŒ</span>
</code></pre></div></div><h5 id="é—®ä¸ºä»€ä¹ˆusememoå¯ä»¥ç¼“å­˜æ•°æ®">é—®ï¼šä¸ºä»€ä¹ˆuseMemoå¯ä»¥ç¼“å­˜æ•°æ®ï¼Ÿ</h5><p>å…¶å®å¯ä»¥æ ¹æ®ä¸Šé¢çš„ç¤ºä¾‹çŒœæµ‹ä¸€ä¸‹ï¼Œï¼ˆæ‰§è¡Œå›è°ƒï¼Œç¼“å­˜å›è°ƒå˜é‡ï¼Ÿï¼Ÿï¼‰ ç»†è¯´çš„è¯è¿™ä¸ªé—®é¢˜å…¶å®å’Œ <code class="language-plaintext highlighter-rouge">Hooks</code> åŸç†æ˜¯å·®ä¸å¤šçš„ã€‚</p><p><strong>é¦–æ¬¡æ¸²æŸ“æ—¶çš„ <code class="language-plaintext highlighter-rouge">useMemo</code>:</strong></p><pre><code class="language-javasccript">export function useMemo&lt;T&gt;(
  create: () =&gt; T,
  deps: Array&lt;mixed&gt; | void | null,
): T {
  const dispatcher = resolveDispatcher();
  return dispatcher.useMemo(create, deps);
}
// dispatcher.useMemo æœ€ç»ˆä¼šè°ƒç”¨ mountMemo

function mountMemo&lt;T&gt;(
  nextCreate: () =&gt; T,
  deps: Array&lt;mixed&gt; | void | null,
): T {
  const hook = mountWorkInProgressHook();
  const nextDeps = deps === undefined ? null : deps;
  const nextValue = nextCreate();
  hook.memoizedState = [nextValue, nextDeps];
  return nextValue;
}
// å¯ä»¥çœ‹åˆ° nextValue (ä¹Ÿå°±æ˜¯éœ€è¦ç¼“å­˜çš„å˜é‡æˆ–è€…JSXå¯¹è±¡)è¢«å­˜å…¥hook.memoizedStateä¸­



function mountWorkInProgressHook(): Hook {
  const hook: Hook = {
    memoizedState: null,

    baseState: null,
    baseQueue: null,
    queue: null,

    next: null,
  };
  // workInProgressHook è¡¨ç¤ºç»„ä»¶æ‰€åˆ›å»ºçš„hooksé“¾è¡¨
  // ä¸ºnullçš„è¯è¡¨ç¤ºå½“å‰hookæ˜¯è¯¥ç»„ä»¶çš„ç¬¬ä¸€ä¸ªhook
  if (workInProgressHook === null) {
    // This is the first hook in the list
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    // Append to the end of the list
    workInProgressHook = workInProgressHook.next = hook;
  }
  return workInProgressHook;
}
// mountWorkInProgressHook 
// åˆ›å»ºä¸€ä¸ªhook
// æ˜¯ç¬¬ä¸€ä¸ªhook, èµ‹å€¼memoizedState = workInProgressHook = hook
// ä¸æ˜¯çš„è¯å°±nextè¿æ¥èµ·æ¥
  // ä¸¾ä¸ªæ —å­
  useA(); // workInProgressHook = hookA
  useB(); // workInProgressHook = hookA.next -&gt; hookB


//ä¸Šé¢çš„ currentlyRenderingFiber åœ¨ renderWithHooks ä¸­èµ‹å€¼ workInProgress(å½“å‰ç»„ä»¶fiber)
export function renderWithHooks&lt;Props, SecondArg&gt;(
  current: Fiber | null,
  workInProgress: Fiber,
  Component: (p: Props, arg: SecondArg) =&gt; any,
  props: Props,
  secondArg: SecondArg,
  nextRenderLanes: Lanes,
): any {
  renderLanes = nextRenderLanes;
  currentlyRenderingFiber = workInProgress;
  ...
  let children = Component(props, secondArg);
  ...
  }
</code></pre><p><strong>å†çœ‹çœ‹updateé˜¶æ®µçš„useMemo</strong></p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// dispatcher.useMemo æœ€ç»ˆä¼šè°ƒç”¨ updateMemo</span>
<span class="kd">function</span> <span class="nx">updateMemo</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="nx">nextCreate</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">deps</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">mixed</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
<span class="p">):</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="c1">// å½“å‰hook</span>
  <span class="kd">const</span> <span class="nx">hook</span> <span class="o">=</span> <span class="nx">updateWorkInProgressHook</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">nextDeps</span> <span class="o">=</span> <span class="nx">deps</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="kc">null</span> <span class="p">:</span> <span class="nx">deps</span><span class="p">;</span>
  <span class="c1">// é¦–æ¬¡æ¸²æŸ“ç¼“å­˜çš„å€¼</span>
  <span class="kd">const</span> <span class="nx">prevState</span> <span class="o">=</span> <span class="nx">hook</span><span class="p">.</span><span class="nx">memoizedState</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">prevState</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nextDeps</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">prevDeps</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">mixed</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nx">prevState</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="c1">// æ¯”è¾ƒä¾èµ–</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">areHookInputsEqual</span><span class="p">(</span><span class="nx">nextDeps</span><span class="p">,</span> <span class="nx">prevDeps</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// å¤ç”¨æ—§å€¼</span>
        <span class="k">return</span> <span class="nx">prevState</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// è®¡ç®—æ–°å€¼</span>
  <span class="kd">const</span> <span class="nx">nextValue</span> <span class="o">=</span> <span class="nx">nextCreate</span><span class="p">();</span>
  <span class="nx">hook</span><span class="p">.</span><span class="nx">memoizedState</span> <span class="o">=</span> <span class="p">[</span><span class="nx">nextValue</span><span class="p">,</span> <span class="nx">nextDeps</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">nextValue</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// updateMemo æ•´ä¸ªé€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„</span>



<span class="c1">// å†çœ‹çœ‹æ¯”è¾ƒä¾èµ–areHookInputsEqual </span>
<span class="kd">function</span> <span class="nx">areHookInputsEqual</span><span class="p">(</span>
  <span class="nx">nextDeps</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">mixed</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">prevDeps</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">mixed</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">prevDeps</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">prevDeps</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nextDeps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">is</span><span class="p">(</span><span class="nx">nextDeps</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">prevDeps</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>å¤§å®¶ä¹Ÿå¯ä»¥ä¸‹é¢ä¾‹å­éªŒè¯ <code class="language-plaintext highlighter-rouge">useMemo</code> å­˜å‚¨ä½ç½®ï¼Œæ§åˆ¶å°æŸ¥çœ‹ <code class="language-plaintext highlighter-rouge">memoizedState</code> ä¸­ <code class="language-plaintext highlighter-rouge">memo</code> ç¼“å­˜çš„æ•°æ®ã€‚</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;&gt;</span>
      <span class="p">{</span><span class="nx">useMemo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Child2::render</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">child2</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>      <span class="p">},</span> <span class="p">[])}</span>
    <span class="o">&lt;</span><span class="sr">/</span><span class="err">&gt;
</span>  <span class="p">);</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">dom</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">__reactContainer$g605vp1tnct</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">memoizedState</span><span class="p">.</span><span class="nx">memoizedState</span><span class="p">);</span>
<span class="nx">print</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nx">JSXå¯¹è±¡</span><span class="p">,</span> <span class="nx">ä¾èµ–</span><span class="p">]</span>
</code></pre></div></div><p>æ‰€ä»¥å½“ <code class="language-plaintext highlighter-rouge">App</code> ç»„ä»¶å†æ¬¡æ¸²æŸ“æ—¶ï¼Œå€˜è‹¥ <code class="language-plaintext highlighter-rouge">useMemo</code> ä¾èµ–é¡¹æ²¡æœ‰å˜æ›´ï¼Œä¾¿ä¼šå¤ç”¨(ä½¿ç”¨ä¸Šæ¬¡å†…å­˜åœ°å€ï¼Œè¿›è€Œæ–°æ—§ <code class="language-plaintext highlighter-rouge">props</code> ä¹Ÿä¼šå…¨ç­‰)ã€‚</p><p><strong>é‚£ä¹ˆuseMemo ç›¸åŒæ•ˆæœçš„å¥½å…„å¼Ÿ â€œpureComponentsâ€ &amp; â€œsholdComponentUpdateâ€; ä»–ä»¬çš„ä½œç”¨çœŸçš„ç›¸ç­‰å—ï¼Ÿ</strong></p><h5 id="purecomponents">pureComponents</h5><p>ç±»ç»„ä»¶åªéœ€è¦ç»§æ‰¿ <code class="language-plaintext highlighter-rouge">pureComponents</code> ä¾¿å¯ä»¥é¿å… <code class="language-plaintext highlighter-rouge">render</code> æ¸²æŸ“ï¼Œæ˜¯ä¸æ˜¯ç¥ä¼¼ <code class="language-plaintext highlighter-rouge">memo</code> , é‚£ä½ çŸ¥é“ä»–ä»¬çš„åŒºåˆ«å—ï¼Ÿ</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Test</span> <span class="kd">extends</span> <span class="nx">PureComponent</span> <span class="p">{</span>

    <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Testsssssssssss</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">return</span> <span class="dl">"</span><span class="s2">Test</span><span class="dl">"</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æºç ä¸­ PureComponent å®ç°</span>
<span class="kd">function</span> <span class="nx">PureComponent</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">updater</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">refs</span> <span class="o">=</span> <span class="nx">emptyObject</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">updater</span> <span class="o">=</span> <span class="nx">updater</span> <span class="o">||</span> <span class="nx">ReactNoopUpdateQueue</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">pureComponentPrototype</span> <span class="o">=</span> <span class="p">(</span><span class="nx">PureComponent</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ComponentDummy</span><span class="p">());</span>
<span class="nx">pureComponentPrototype</span><span class="p">.</span><span class="kd">constructor</span> <span class="o">=</span> <span class="nx">PureComponent</span><span class="p">;</span>
<span class="c1">// ç»§æ‰¿Component</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">pureComponentPrototype</span><span class="p">,</span> <span class="nx">Component</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="c1">// è¿™é‡Œç•™æ„ä¸€ä¸‹ isPureReactComponent æ ‡è¯†</span>
<span class="nx">pureComponentPrototype</span><span class="p">.</span><span class="nx">isPureReactComponent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</code></pre></div></div><p>å¯ä»¥åœ¨ <code class="language-plaintext highlighter-rouge">updateClassInstance</code> ä¸­çœ‹åˆ°å…¨è²Œï¼Œçœç•¥äº†éƒ¨åˆ†ä»£ç  çœ‹ä¸Šå»ä»£ç é‡å¾ˆå¤šï¼Œå…¶å®æ¯ç¯é€»è¾‘å¾ˆæ¸…æ™°, ä¸»è¦ä¸º <code class="language-plaintext highlighter-rouge">componentDidUpdate</code> å’Œ <code class="language-plaintext highlighter-rouge">getSnapshotBeforeUpdate</code> æ·»åŠ æ ‡è®° è¿”å›æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“å¸ƒå°”æ ‡è¯†ï¼ˆtrue -&gt; éœ€è¦æ¸²æŸ“ | false -&gt; å¤ç”¨ï¼‰</p><ol><li>åˆ¤æ–­æ–°æ—§ <code class="language-plaintext highlighter-rouge">props</code> ä¸ <code class="language-plaintext highlighter-rouge">data</code> å†…å­˜åœ°å€æ˜¯å¦ä¸€è‡´ï¼Œä¸Šä¸‹æ–‡æ˜¯å¦å˜åŒ–<ul><li>æ²¡æœ‰å˜åŒ–å¤ç”¨æ”¾å› <code class="language-plaintext highlighter-rouge">false</code>, ä¸ºç›¸å…³ç”Ÿå‘½å‘¨æœŸæ‰“æ·»åŠ å¯¹åº”æ ‡è¯†</li></ul></li><li>è®¡ç®— <code class="language-plaintext highlighter-rouge">shouldUpdate</code><ul><li><code class="language-plaintext highlighter-rouge">shouldUpdate</code> ä¸º <code class="language-plaintext highlighter-rouge">false</code> æ—¶ä»£è¡¨å¤ç”¨ï¼Œä¸ºç›¸å…³ç”Ÿå‘½å‘¨æœŸæ‰“æ·»åŠ å¯¹åº”æ ‡è¯†ï¼ˆä¸ä¸Šé¢ 1-a ä¸€è‡´ï¼‰</li><li><code class="language-plaintext highlighter-rouge">shouldUpdate</code> ä¸º <code class="language-plaintext highlighter-rouge">true</code> ä»£è¡¨éœ€è¦é‡æ–° <code class="language-plaintext highlighter-rouge">render</code>ï¼Œå­˜åœ¨ <code class="language-plaintext highlighter-rouge">componentWillUpdate</code> or <code class="language-plaintext highlighter-rouge">UNSAFE_componentWillUpdate</code> æ‰§è¡Œã€‚</li></ul></li></ol><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">updateClassInstance</span><span class="p">(</span>
  <span class="nx">current</span><span class="p">:</span> <span class="nx">Fiber</span><span class="p">,</span>
  <span class="nx">workInProgress</span><span class="p">:</span> <span class="nx">Fiber</span><span class="p">,</span>
  <span class="nx">ctor</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span>
  <span class="nx">newProps</span><span class="p">:</span> <span class="nx">any</span><span class="p">,</span>
  <span class="nx">renderLanes</span><span class="p">:</span> <span class="nx">Lanes</span><span class="p">,</span>
<span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">stateNode</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">unresolvedOldProps</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">memoizedProps</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">oldProps</span> <span class="o">=</span>
    <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">elementType</span>
      <span class="p">?</span> <span class="nx">unresolvedOldProps</span>
      <span class="p">:</span> <span class="nx">resolveDefaultProps</span><span class="p">(</span><span class="nx">workInProgress</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">unresolvedOldProps</span><span class="p">);</span>
  <span class="nx">instance</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">oldProps</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">unresolvedNewProps</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">pendingProps</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">oldContext</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">contextType</span> <span class="o">=</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">contextType</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">nextContext</span> <span class="o">=</span> <span class="nx">emptyContextObject</span><span class="p">;</span>
  <span class="p">...</span>

  <span class="kd">const</span> <span class="nx">oldState</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">memoizedState</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">newState</span> <span class="o">=</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">oldState</span><span class="p">);</span>
  <span class="nx">newState</span> <span class="o">=</span> <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">memoizedState</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span>
    <span class="nx">unresolvedOldProps</span> <span class="o">===</span> <span class="nx">unresolvedNewProps</span> <span class="o">&amp;&amp;</span>
    <span class="nx">oldState</span> <span class="o">===</span> <span class="nx">newState</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="nx">hasContextChanged</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="nx">checkHasForceUpdateAfterProcessing</span><span class="p">()</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">componentDidUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">unresolvedOldProps</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedProps</span> <span class="o">||</span>
        <span class="nx">oldState</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedState</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">Update</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">getSnapshotBeforeUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">unresolvedOldProps</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedProps</span> <span class="o">||</span>
        <span class="nx">oldState</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedState</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">Snapshot</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="c1">// é‡æ–°è®¡ç®— shouldUpdate</span>
  <span class="c1">// éœ€è¦ç•™æ„ checkShouldComponentUpdate</span>
  <span class="kd">const</span> <span class="nx">shouldUpdate</span> <span class="o">=</span>
    <span class="nx">checkHasForceUpdateAfterProcessing</span><span class="p">()</span> <span class="o">||</span>
    <span class="nx">checkShouldComponentUpdate</span><span class="p">(</span>
      <span class="nx">workInProgress</span><span class="p">,</span>
      <span class="nx">ctor</span><span class="p">,</span>
      <span class="nx">oldProps</span><span class="p">,</span>
      <span class="nx">newProps</span><span class="p">,</span>
      <span class="nx">oldState</span><span class="p">,</span>
      <span class="nx">newState</span><span class="p">,</span>
      <span class="nx">nextContext</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="c1">// é‡æ–°æ¸²æŸ“ render </span>
  <span class="c1">// å­˜åœ¨ componentWillUpdate or UNSAFE_componentWillUpdate æ‰§è¡Œ</span>
  <span class="c1">// ä¸º componentDidUpdate and getSnapshotBeforeUpdate æ·»åŠ æ ‡è®°</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">shouldUpdate</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="o">!</span><span class="nx">hasNewLifecycles</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">UNSAFE_componentWillUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span> <span class="o">||</span>
        <span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">componentWillUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">componentWillUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">componentWillUpdate</span><span class="p">(</span><span class="nx">newProps</span><span class="p">,</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">nextContext</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">UNSAFE_componentWillUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">UNSAFE_componentWillUpdate</span><span class="p">(</span><span class="nx">newProps</span><span class="p">,</span> <span class="nx">newState</span><span class="p">,</span> <span class="nx">nextContext</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">componentDidUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">Update</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">getSnapshotBeforeUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">Snapshot</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// å¤ç”¨</span>
    <span class="c1">// ä¸º componentDidUpdate and getSnapshotBeforeUpdate æ·»åŠ æ ‡è®°</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">componentDidUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">unresolvedOldProps</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedProps</span> <span class="o">||</span>
        <span class="nx">oldState</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedState</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">Update</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">getSnapshotBeforeUpdate</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">unresolvedOldProps</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedProps</span> <span class="o">||</span>
        <span class="nx">oldState</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">memoizedState</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">Snapshot</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">memoizedProps</span> <span class="o">=</span> <span class="nx">newProps</span><span class="p">;</span>
    <span class="nx">workInProgress</span><span class="p">.</span><span class="nx">memoizedState</span> <span class="o">=</span> <span class="nx">newState</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">instance</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">newProps</span><span class="p">;</span>
  <span class="nx">instance</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">newState</span><span class="p">;</span>
  <span class="nx">instance</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">nextContext</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">shouldUpdate</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">checkShouldComponentUpdate</code> ä¸­é€»è¾‘éå¸¸ç®€å•ï¼š</p><ol><li>å­˜åœ¨ <code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> è°ƒç”¨ï¼ˆ<code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> ä¼˜å…ˆçº§é«˜äº <code class="language-plaintext highlighter-rouge">pureComponents</code>ï¼‰</li><li>å¦åˆ™åˆ¤æ–­æ˜¯å¦å¸¦æœ‰ <code class="language-plaintext highlighter-rouge">isPureReactComponent</code> æ ‡è¯†<ul><li>ä½¿ç”¨é»˜è®¤æ¯”è¾ƒ <code class="language-plaintext highlighter-rouge">shallowEqual</code> (è€æ¼”å‘˜äº†ä¸ä¸Šé¢ <code class="language-plaintext highlighter-rouge">memo</code> ä¸€è‡´)</li><li>é™¤äº†æ¯”è¾ƒ <code class="language-plaintext highlighter-rouge">props</code> å¤–è¿˜ä¼šæ¯”è¾ƒ <code class="language-plaintext highlighter-rouge">state</code> æ»¡è¶³ä¸€ä¸ªæ¡ä»¶å³å¯</li></ul></li><li>è¿”å›æ˜¯å¦æ¸²æŸ“çŠ¶æ€æ ‡è¯†ã€‚</li></ol><pre><code class="language-javasccript">function checkShouldComponentUpdate(
  workInProgress,
  ctor,
  oldProps,
  newProps,
  oldState,
  newState,
  nextContext,
) {
  const instance = workInProgress.stateNode;
  if (typeof instance.shouldComponentUpdate === 'function') {
    const shouldUpdate = instance.shouldComponentUpdate(
      newProps,
      newState,
      nextContext,
    );

    return shouldUpdate;
  }

  if (ctor.prototype &amp;&amp; ctor.prototype.isPureReactComponent) {
    return (
      !shallowEqual(oldProps, newProps) || !shallowEqual(oldState, newState)
    );
  }

  return true;
}
</code></pre><p>ä¸Šé¢ä¹ŸéªŒè¯äº† <code class="language-plaintext highlighter-rouge">PureComponents</code> ä¸ <code class="language-plaintext highlighter-rouge">memo</code> çš„å·®å¼‚æ€§:</p><ul><li>æ¯”è¾ƒè§„åˆ™çš„å·®å¼‚æ€§<ul><li>é™¤äº†æ¯”è¾ƒ <code class="language-plaintext highlighter-rouge">props</code> è¿˜ä¼šæ¯”è¾ƒ <code class="language-plaintext highlighter-rouge">state</code></li><li><code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> ä¼ å‚ä¸ <code class="language-plaintext highlighter-rouge">memo</code> å›è°ƒä¹Ÿä¸ç›¸åŒ</li></ul></li><li>è€Œ <code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> æ›´åƒæ˜¯ <code class="language-plaintext highlighter-rouge">memo</code> çš„ç¬¬äºŒä¸ªå›è°ƒ<ul><li>ä¼˜å…ˆçº§é«˜äºé»˜è®¤ <code class="language-plaintext highlighter-rouge">shallowEqual</code> æ¯”è¾ƒ</li></ul></li></ul><p>æ‰€ä»¥è¿™ä¹ˆä¸€çœ‹ <code class="language-plaintext highlighter-rouge">memo</code> åƒæ˜¯ <code class="language-plaintext highlighter-rouge">PureComponents</code> + <code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> çš„æµ“ç¼©ç‰ˆğŸ˜„ã€‚</p><h5 id="shouldupdate-æ¸²æŸ“æ ‡è¯†æ˜¯æ€ä¹ˆå½±å“æ¸²æŸ“çš„">shouldUpdate æ¸²æŸ“æ ‡è¯†æ˜¯æ€ä¹ˆå½±å“æ¸²æŸ“çš„ï¼Ÿ</h5><p>åœ¨ <code class="language-plaintext highlighter-rouge">finishClassComponent</code> ä¸­ä¼šæ ¹æ® <code class="language-plaintext highlighter-rouge">shouldUpdate</code> æ ‡è¯†æ¥åˆ¤æ–­å¤ç”¨ è¿™ä¸ª <code class="language-plaintext highlighter-rouge">bailoutOnAlreadyFinishedWord</code> ï¼ˆä¹Ÿæ˜¯è€æ¼”å‘˜äº†ï¼Œä¸Šé¢å¤ç”¨éƒ½æœ‰å‡ºç°,ï¼Œå¤§å®¶æ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œäº†è§£ï¼Œæ­¤å¤„ä¸å±•å¼€ï¼‰å¤ç”¨ <code class="language-plaintext highlighter-rouge">Filber</code>ã€‚</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¼‚å¸¸</span>
<span class="kd">const</span> <span class="nx">didCaptureError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">workInProgress</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="nx">DidCapture</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">NoFlags</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">shouldUpdate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">didCaptureError</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">hasContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">invalidateContextProvider</span><span class="p">(</span><span class="nx">workInProgress</span><span class="p">,</span> <span class="nx">Component</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// å¤ç”¨</span>
  <span class="k">return</span> <span class="nx">bailoutOnAlreadyFinishedWork</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">workInProgress</span><span class="p">,</span> <span class="nx">renderLanes</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// å­˜åœ¨å¼‚å¸¸</span>
<span class="k">if</span> <span class="p">(</span>
    <span class="nx">didCaptureError</span> <span class="o">&amp;&amp;</span>
    <span class="k">typeof</span> <span class="nx">Component</span><span class="p">.</span><span class="nx">getDerivedStateFromError</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nx">nextChildren</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">enableProfilerTimer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stopProfilerTimerIfRunning</span><span class="p">(</span><span class="nx">workInProgress</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// é‡æ–° render</span>
      <span class="nx">nextChildren</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="p">...</span>
</code></pre></div></div><p>å¥½ç°åœ¨åœ¨å›æº¯ä¹‹å‰çš„é—®é¢˜: ç»™æ‰€æœ‰çš„ <code class="language-plaintext highlighter-rouge">Class</code> ç»„ä»¶åŒ…è£¹ <code class="language-plaintext highlighter-rouge">PureComponents</code> åˆé€‚å—ï¼Ÿ</p><blockquote><p>å…¶å®ä¸ ä¸Šé¢ç»™æ‰€æœ‰ç»„ä»¶åŒ…è£¹ <code class="language-plaintext highlighter-rouge">memo</code> çš„é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œç”šè‡³ <code class="language-plaintext highlighter-rouge">PureComponents</code> é»˜è®¤æ¯”è¾ƒæŸäº›æƒ…å†µæ€§èƒ½è¿˜æ˜¯æ¯” <code class="language-plaintext highlighter-rouge">memo</code> é»˜è®¤æ¯”è¾ƒæ›´å·®ï¼Œæ¯”å¦‚100+çš„æ–°æ—§ <code class="language-plaintext highlighter-rouge">props</code> éƒ½ç›¸ç­‰æ—¶, <code class="language-plaintext highlighter-rouge">ä¼šéå†æ¯”è¾ƒä¸€æ¬¡ååˆä¼šéå†æ¯”è¾ƒæ–°æ—§state</code>, å€˜è‹¥ <code class="language-plaintext highlighter-rouge">state</code> ä¹Ÿæ˜¯100+ å‘¢ï¼ŸğŸ¤ª</p></blockquote><h4 id="å…¶ä»–ä¼˜åŒ–">å…¶ä»–ä¼˜åŒ–</h4><p>é¡¹ç›®ä¸­ç»å¸¸å¯ä»¥çœ‹åˆ°ç»„ä»¶é‡Œå†™ç»„ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œä¸¾ä¾‹å¹¶ä¸æ˜¯è¯´è¿™æ ·å†™ä¸è¡Œï¼Œå¯¹äºæŸäº›åœºæ™¯ä¼šæœ‰æ€§èƒ½å·®å¼‚ã€‚</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Item2</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Item2 is Mount</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">},</span> <span class="p">[]);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Item2 is Render</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Item</span><span class="o">------&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">data</span><span class="p">,</span> <span class="nx">setData</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">Item</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Item is Mount</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">},</span> <span class="p">[]);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Item is Render</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Item</span><span class="o">------&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="p">{</span>
            <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span><span class="na">length</span><span class="p">:</span> <span class="mi">10</span><span class="p">}).</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">Item</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span><span class="sr">/&gt;</span><span class="err">)
</span>        <span class="p">}</span>
        <span class="p">{</span>
            <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span><span class="na">length</span><span class="p">:</span> <span class="mi">10</span><span class="p">}).</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">Item2</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span><span class="sr">/&gt;</span><span class="err">)
</span>        <span class="p">}</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">hanldeClick</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">è«ç¢è€å­</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">);</span>
<span class="p">}</span>

<span class="o">--------------------</span>
<span class="nx">æ¯å½“ç‚¹å‡»è§¦å‘Appæ›´æ–°æ—¶</span><span class="p">,</span> <span class="nx">æ‰“å°è¾“å‡ºå¦‚ä¸‹</span>
<span class="nx">click</span> <span class="mi">1</span><span class="nx">æ¬¡</span>
<span class="nx">print</span> <span class="o">-&gt;</span>
  <span class="nx">Item</span> <span class="nx">is</span> <span class="nx">Render</span>
  <span class="nx">Item2</span> <span class="nx">is</span> <span class="nx">Render</span>
  <span class="nx">Item2</span> <span class="nx">is</span> <span class="nx">Mount</span>
<span class="nx">click</span> <span class="mi">2</span><span class="nx">æ¬¡</span>
<span class="nx">print</span> <span class="o">-&gt;</span>
  <span class="nx">Item</span> <span class="nx">is</span> <span class="nx">Render</span>
  <span class="nx">Item2</span> <span class="nx">is</span> <span class="nx">Render</span>
  <span class="nx">Item2</span> <span class="nx">is</span> <span class="nx">Mount</span>
  <span class="nx">Item</span> <span class="nx">is</span> <span class="nx">Render</span>
  <span class="nx">Item2</span> <span class="nx">is</span> <span class="nx">Render</span>
  <span class="nx">Item2</span> <span class="nx">is</span> <span class="nx">Mount</span>
</code></pre></div></div><p>æ¯å½“ç‚¹å‡»æ—¶ã€‚ä½ ä¼šå‘ç°æ¯æ¬¡ <code class="language-plaintext highlighter-rouge">Item</code> ç»„ä»¶å†…çš„ <code class="language-plaintext highlighter-rouge">useEffect</code> éƒ½ä¼šé‡æ–°æ‰§è¡Œï¼Œ è€Œ <code class="language-plaintext highlighter-rouge">Item2</code> ç»„ä»¶ä¸ä¼šè¿™æ˜¯ä¸ºä½•ï¼Ÿ</p><ul><li>å”‰æœ€å¼€å§‹ä¸æ˜¯è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">App</code> ç»„ä»¶æ›´æ–°ï¼Œå­ç»„ä»¶çš„ <code class="language-plaintext highlighter-rouge">JSX</code> éƒ½ä¼šé‡æ–°åˆ›å»ºï¼Œå¯¼è‡´å†…å­˜åœ°å€ä¸åŒï¼Œè¿›è€Œæ¸²æŸ“å­ç»„ä»¶<ul><li>æŒ‰ç…§è¿™ä¸ªé€»è¾‘æ¥è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">Item</code> ä¸ <code class="language-plaintext highlighter-rouge">Item2</code> ç»„ä»¶ä¸åº”è¯¥ä¼šæœ‰å·®å¼‚æ‰å¯¹å‘€</li></ul></li><li>çœ‹ä¸Šå» <code class="language-plaintext highlighter-rouge">Item</code> ç»„ä»¶æ¯æ¬¡éƒ½åˆå§‹åŒ–äº†ä¸€èˆ¬ï¼Œè¿™æ˜¯ä¸ºä½•ï¼Ÿ</li></ul><p>è¿™ä¸ªè§£é‡Šèµ·æ¥æœ‰ç‚¹éº»çƒ¦ï¼Œéœ€è¦äº†è§£ <code class="language-plaintext highlighter-rouge">Diff</code> ï¼Œ <code class="language-plaintext highlighter-rouge">Hooks åŸç†</code>ä»¥åŠ <code class="language-plaintext highlighter-rouge">commitæ¸²æŸ“æµ</code>ã€‚</p><p>åœ¨ <code class="language-plaintext highlighter-rouge">reconcileChildrenArray</code> ï¼ˆä¹Ÿå« <code class="language-plaintext highlighter-rouge">Array Diff</code>ï¼‰-&gt; <code class="language-plaintext highlighter-rouge">updateSlot</code> -&gt; <code class="language-plaintext highlighter-rouge">updateElement</code>ä¸­ å¯ä»¥æ‰¾åˆ°æƒ³è¦çš„ç­”æ¡ˆã€‚</p><pre><code class="language-javasript">function updateElement(
    returnFiber: Fiber,
    current: Fiber | null,
    element: ReactElement,
    lanes: Lanes,
  ): Fiber {
    if (current !== null) {
      if (
        current.elementType === element.type
      ) {
        // å…‹éš†å¤ç”¨ Fiber
        const existing = useFiber(current, element.props);
        existing.ref = coerceRef(returnFiber, current, element);
        existing.return = returnFiber;
        return existing;
      } else if (enableBlocksAPI &amp;&amp; current.tag === Block) {
        ...
      }
    }
    // é‡æ–°åˆ›å»º Fiber
    const created = createFiberFromElement(element, returnFiber.mode, lanes);
    created.ref = coerceRef(returnFiber, current, element);
    created.return = returnFiber;
    return created;
  }
</code></pre><p>ä¸Šé¢åªéœ€è¦ç•™æ„ <code class="language-plaintext highlighter-rouge">current.elementType === element.type</code></p><ul><li><p><code class="language-plaintext highlighter-rouge">current</code> è¡¨ç¤ºæ—§çš„ <code class="language-plaintext highlighter-rouge">Fiber</code> å•å…ƒï¼Œ <code class="language-plaintext highlighter-rouge">element</code> ä¹Ÿå°±æ˜¯æœ€å¼€å§‹ä»‹ç»è¿‡çš„ <code class="language-plaintext highlighter-rouge">JSX</code> å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªé€»è¾‘å°±è¡¨ç¤ºåˆ¤æ–­ Item ç»„ä»¶å¼•ç”¨åœ°å€ï¼Œå¦‚æœç›¸åŒå…‹éš†å¤ç”¨ <code class="language-plaintext highlighter-rouge">Fiber</code>, ä¸åŒä¾¿ä¼šæ–°å¢ <code class="language-plaintext highlighter-rouge">Fiber</code>;</p></li><li><p>è€Œå¯¹äº <code class="language-plaintext highlighter-rouge">hooks</code> åˆ†ä¸ºä¿©ä¸ªé˜¶æ®µï¼Œé¦–æ¬¡æ¸²æŸ“åˆå§‹åŒ–åˆ›å»º <code class="language-plaintext highlighter-rouge">hooks</code> é“¾è¡¨ï¼Œä»¥åŠ <code class="language-plaintext highlighter-rouge">update</code> é˜¶æ®µç§»åŠ¨é“¾è¡¨è·å–å½“å‰æ¯ä¸ªå¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">hook</code> è®¡ç®—ç»“æœã€‚è€Œ <code class="language-plaintext highlighter-rouge">hooks</code> é“¾è¡¨è¢«æŒ‚è½½åœ¨ç»„ä»¶çš„ <code class="language-plaintext highlighter-rouge">Fiber</code> ä¸Šã€‚ å› æ­¤å½“é‡æ–°åˆ›å»º <code class="language-plaintext highlighter-rouge">Fiber</code> æ—¶ï¼Œä¸Šæ¬¡åˆå§‹åŒ–çš„ <code class="language-plaintext highlighter-rouge">hooks</code> é“¾è¡¨å¹¶æ²¡æœ‰å¾—åˆ°ä¿ç•™ï¼Œè¿›è€Œ <code class="language-plaintext highlighter-rouge">renderWithHooks</code> å†æ¬¡è¿›å…¥æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">Item</code> ç»„ä»¶æ—¶ï¼Œä»»ç„¶æ˜¯åˆ›å»º <code class="language-plaintext highlighter-rouge">Hooksé“¾è¡¨</code>ï¼Œ<code class="language-plaintext highlighter-rouge">commit</code> é˜¶æ®µè°ƒåº¦ ï¼ˆè¿™é‡Œåç»­æ–‡ç« ä¼šè¯´æ˜ï¼‰ã€‚</p></li><li><p>è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ <code class="language-plaintext highlighter-rouge">Item</code> ç»„ä»¶ä¼šæ¯æ¬¡éƒ½ä¼šæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">useEffect</code> å›è°ƒï¼Œè¿™é‡Œå·®å¼‚åŒ–é™¤äº†åˆ›å»º <code class="language-plaintext highlighter-rouge">Fiber</code> çš„å¼€é”€å¤–ï¼Œå¦‚æœå­˜åœ¨ <code class="language-plaintext highlighter-rouge">Hooks</code> è¿˜æœ‰ <code class="language-plaintext highlighter-rouge">Hooks</code> é“¾è¡¨æ¯æ¬¡åˆ›å»ºçš„å¼€é”€ã€‚</p></li></ul><h5 id="æŠŠé€»è¾‘å…¨å¥—åœ¨setdataä¼šæœ‰ä»€ä¹ˆé—®é¢˜">æŠŠé€»è¾‘å…¨å¥—åœ¨setDataä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h5><p>å¯èƒ½ä¼šè§‰å¾—ä¸ä¼šæœ‰å½±å“ï¼Œå› ä¸ºæ‰§è¡Œç‚¹å‡»å›è°ƒæ—¶ ä»ç‚¹å‡»åˆ°è§†å›¾æ”¹å˜æ—¶é—´ç»´åº¦ä¸ä¼šå› ä¸ºä½ å°†é€»è¾‘æŠ½ç¦»è€Œæ”¹å˜ï¼Œä¸è¿‡æ˜¯é€»è¾‘æ‰§è¡Œæ—¶æœºçš„æ”¹å˜ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯ç‚¹å‡»å›è°ƒæ‰§è¡Œé€»è¾‘åè®¾ç½®å€¼ã€‚</li><li>ä¸€ä¸ªæ˜¯ä¼ å…¥å›è°ƒååˆ° <code class="language-plaintext highlighter-rouge">renderWithHooks</code>ï¼Œ è°ƒç”¨ <code class="language-plaintext highlighter-rouge">App component</code>, <code class="language-plaintext highlighter-rouge">hooks update</code> è®¡ç®—å€¼çš„å·®åˆ«ã€‚ emmm, ä½ è¿™è¯´ç¡®å®æ²¡é”™ï¼Œå€˜è‹¥ä½ å¼€å¯äº†å¹¶å‘æ¨¡å¼ï¼Œé‚£ä¾¿ä¼šæœ‰å·®å¼‚äº†ï¼ˆå¯ä»¥æƒ³æƒ³ï¼‰</li></ul><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¸¾ä¸ªæ —å­</span>
<span class="c1">// å¦‚æœä¸€ä¸ªhooks æœ‰å¤šä¸ªupdate å•å…ƒ</span>
<span class="c1">// è¿™é‡Œçš„lang è¡¨ç¤ºä¼˜å…ˆçº§, action è¡¨ç¤ºå¯¹åº”éœ€è¦è®¡ç®—çš„å€¼</span>
<span class="nx">hooks</span> <span class="o">-&gt;</span> <span class="nx">queue</span> <span class="o">-&gt;</span> 
              <span class="nx">update1</span> <span class="o">-&gt;</span> <span class="nx">update2</span> <span class="o">-&gt;</span>             <span class="nx">update3</span>
              <span class="nx">lang</span><span class="o">=</span><span class="mi">3</span>     <span class="nx">lang</span><span class="o">=</span><span class="mi">1</span>                 <span class="nx">lang</span><span class="o">=</span><span class="mi">3</span>
              <span class="nx">action</span><span class="o">=</span><span class="mi">1</span>   <span class="nx">action</span><span class="o">=</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span>    <span class="nx">action</span><span class="o">=</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="o">+</span><span class="nx">more</span>

<span class="c1">// å¯ä»¥çœ‹åˆ° update3 ä¸ºé€»è¾‘å›è°ƒ </span>
<span class="c1">// å‡è®¾å½“å‰æ¸²æŸ“ä¼˜å…ˆçº§ä¸º3, é‚£ä¹ˆæœ¬æ¬¡æ»¡è¶³æ¡ä»¶åº”è¯¥æ‰§è¡Œçš„æ˜¯ update1 + update3</span>

<span class="nx">éå†updateé“¾è¡¨</span>
<span class="nx">update1</span> <span class="o">-&gt;</span> <span class="nx">update2</span> <span class="o">-&gt;</span> <span class="nx">update3</span>
  <span class="mi">1</span>
  <span class="o">^</span>
<span class="nx">update1æ»¡è¶³æ¸²æŸ“æ¡ä»¶</span>
<span class="nx">newState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">newBaseState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nx">update1</span> <span class="o">-&gt;</span> <span class="nx">update2</span> <span class="o">-&gt;</span> <span class="nx">update3</span>
            <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span>
              <span class="o">^</span>
<span class="nx">update2ä¸æ»¡è¶³æ¸²æŸ“æ¡ä»¶</span>
<span class="nx">baseFirst</span> <span class="o">=</span> <span class="nx">update2</span>
<span class="nx">newState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">newBaseState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


<span class="nx">update1</span> <span class="o">-&gt;</span> <span class="nx">update2</span> <span class="o">-&gt;</span> <span class="nx">update3</span>
                      <span class="nx">d</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="nx">more</span>
                        <span class="o">^</span>
<span class="nx">update3æ»¡è¶³æ¸²æŸ“æ¡ä»¶</span>
<span class="nx">baseFirst</span> <span class="o">=</span> <span class="nx">update2</span> <span class="o">-&gt;</span> <span class="nx">update3</span>
<span class="nx">newState</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="nx">more</span> <span class="nx">çš„ç»“æœ</span><span class="p">;</span>
<span class="nx">newBaseState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nx">é‚£ä¹ˆé¡µé¢ä¸Šdataä¼šæš‚æ—¶å±•ç¤º</span> <span class="nx">newStateçš„ç»“æœ</span><span class="err">ã€‚</span>
<span class="nx">ä¸‹æ¬¡æ›´æ–°ä¼šæ‰§è¡Œä¸Šæ¬¡è·³è¿‡çš„é“¾è¡¨ä»¥newBaseStateä¸ºåŸºå‡†</span><span class="p">,</span> <span class="nx">baseFirst</span><span class="err">ï¼ˆ</span><span class="nx">update2</span> <span class="o">-&gt;</span> <span class="nx">update3</span><span class="err">ï¼‰</span>
<span class="nx">å› æ­¤ä½ ä¼šå‘ç°</span><span class="err">ï¼Œ</span><span class="nx">update3</span> <span class="nx">è¿™ä¸ªé€»è¾‘å›è°ƒå•å…ƒè¢«æ‰§è¡Œè®¡ç®—äº†ä¿©æ¬¡</span>
</code></pre></div></div><p>è‡³äºhooksé“¾è¡¨è®¡ç®—è¯¦ç»†æµç¨‹æœ‰æœºä¼šåç»­æ–‡ç« è¡¥å……ğŸ˜</p><h4 id="usecontent-ä¸æ­£å½“ä½¿ç”¨">useContent ä¸æ­£å½“ä½¿ç”¨</h4><p>è¿™é‡Œç»™ä¸ªç»“è®ºï¼Œå…·ä½“å‚è€ƒ <code class="language-plaintext highlighter-rouge">useContent</code> ç« èŠ‚; å½“ä¸Šä¸‹æ–‡æ›´æ–°æ—¶ä¼šé¢å¤–æ·±åº¦ä¼˜å…ˆéå† <code class="language-plaintext highlighter-rouge">Fiber</code> åŒ¹é…æ¶ˆè´¹è€…çš„ <code class="language-plaintext highlighter-rouge">Context</code>, å› æ­¤å½“ <code class="language-plaintext highlighter-rouge">Provider</code> åµŒå¥—çš„å†…å®¹è¶Šå¤šï¼ˆæ¯”å¦‚æ ¹å…ƒç´ ä¸Šï¼‰ï¼Œéå†çš„æˆæœ¬å°±è¶Šé«˜ï¼›ç»„ä»¶å†…è€¦åˆä½¿ç”¨æ›´ä¸ºåˆé€‚ã€‚</p><p><strong>é‚£ä¹ˆæœ‰ä»€ä¹ˆåˆé€‚çš„æ–¹å¼å¤§èŒƒå›´ä¼ å€¼å‘¢?</strong></p><p>ç”¨è¿‡ <code class="language-plaintext highlighter-rouge">Vue</code> çš„åŒå­¦éƒ½çŸ¥é“ <code class="language-plaintext highlighter-rouge">MVVM</code> çš„åŸç†ï¼Œå¯¹å±æ€§è¿›è¡ŒåŠ«æŒï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">VNode</code> åˆ›å»ºé˜¶æ®µè·å–å±æ€§ï¼Œä¸ºå…¶æ·»åŠ å¯¹åº”ç»„ä»¶çš„ <code class="language-plaintext highlighter-rouge">updateComponent</code>ï¼Œå±æ€§æ›´æ–° <code class="language-plaintext highlighter-rouge">setter</code> è°ƒåº¦ä»»åŠ¡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">updateComponent</code> åˆ›å»º <code class="language-plaintext highlighter-rouge">VNode Tree</code> æ¯”è¾ƒæ›´æ–°è§†å›¾ã€‚</p><p>é€šè¿‡ç»“åˆ <code class="language-plaintext highlighter-rouge">Proxy</code>ï¼Œ å°±å¯ä»¥å†çŠ¶æ€å˜æ›´æ—¶æ”¶é›†æ‰€æœ‰çš„æ¶ˆè´¹è€…ï¼Œæ‰¹é‡æ›´æ–° ï¼ˆå¸‚é¢ä¸Šä¹Ÿæœ‰ç›¸å…³çš„åº“è‡ªè¡Œäº†è§£ï¼‰ã€‚</p><p><strong>å°demo</strong></p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Store</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">lineComponent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">updateMap</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
      <span class="kd">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">componentMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">componentMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">lineComponent</span><span class="p">))</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">componentMap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">lineComponent</span><span class="p">);</span>
                <span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">prop</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">componentMap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">lineComponent</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Set</span><span class="p">([</span><span class="nx">prop</span><span class="p">]));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
      <span class="p">},</span>
      <span class="na">set</span><span class="p">:</span> <span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">updateMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">updateMap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">[</span><span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">value</span><span class="p">])</span>
            <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="kd">let</span> <span class="nx">componentMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">useUpdate</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">useUpdate</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="p">[</span><span class="nx">_</span><span class="p">,</span> <span class="kd">set</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">updateMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="p">();</span>
            <span class="nx">proxy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
            <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>
  
    <span class="k">this</span><span class="p">.</span><span class="nx">useStore</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">proxy</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">Provider</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Provider</span><span class="p">({</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">children</span> <span class="p">})</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span>
        <span class="o">&lt;&gt;</span>
          <span class="p">{</span> <span class="nx">children</span> <span class="p">}</span>
        <span class="o">&lt;</span><span class="sr">/</span><span class="err">&gt;
</span>      <span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kd">let</span> <span class="nx">defaultEqual</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">equal</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">componentMap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">lineComponent</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">updateMap</span> <span class="o">&amp;&amp;</span> <span class="nx">updateMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">equal</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">equal</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="nx">next</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">prev</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">Component</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">equal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">id</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">lineComponent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">JSX</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">defaultEqual</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">equal</span><span class="p">));</span>
      <span class="nx">lineComponent</span> <span class="o">=</span> <span class="nx">JSX</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">JSX</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div><p>ä½¿ç”¨</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">store</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">wujie</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">age</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2-</span><span class="dl">'</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">Demo</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">Component</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">{</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">age</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">useStore</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="na">age</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">age</span>
    <span class="p">}));</span>
    <span class="kd">let</span> <span class="kd">set</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">useUpdate</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
            <span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">,</span><span class="mi">33</span><span class="p">)</span>
            <span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">age</span><span class="dl">'</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
        <span class="p">}}</span><span class="o">&gt;</span><span class="nx">data</span> <span class="o">---</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">}</span><span class="o">--</span><span class="p">{</span><span class="nx">age</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">store</span><span class="p">.</span><span class="nx">Provider</span><span class="o">&gt;</span>
        <span class="p">{</span>
            <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">render.....</span><span class="dl">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
                        <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">b</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span><span class="o">&gt;</span><span class="nx">a</span><span class="o">---</span><span class="p">{</span><span class="nx">a</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>                        <span class="o">&lt;</span><span class="nx">Demo</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>                <span class="p">);</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="o">&lt;</span><span class="sr">/store.Provider</span><span class="err">&gt;
</span><span class="p">)</span>
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>æ–‡æ¡£ä¿¡æ¯</h3><ul><li>æœ¬æ–‡ä½œè€…ï¼š<a href="https://scriptoverture.github.io/blog" target="_blank">scriptoverture</a></li><li>æœ¬æ–‡é“¾æ¥ï¼š<a href="https://scriptoverture.github.io/blog/2024/09/22/React-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" target="_blank">https://scriptoverture.github.io/blog/2024/09/22/React-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</a></li><li>ç‰ˆæƒå£°æ˜ï¼šè‡ªç”±è½¬è½½-éå•†ç”¨-éè¡ç”Ÿ-ä¿æŒç½²åï¼ˆ<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">åˆ›æ„å…±äº«3.0è®¸å¯è¯</a>ï¼‰</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://giscus.app/client.js" data-repo="scriptoverture/blog" data-repo-id="R_kgDOMq9zeA" data-category="Announcements" data-category-id="DIC_kwDOMq9zeM4CiHLc" data-mapping="title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://scriptoverture.github.io/blog/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://scriptoverture.github.io/blog/assets/search_data.json?v=1758300993', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://scriptoverture.github.io/blog/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> Â© 2024 <span title="scriptoverture">scriptoverture</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/https:/blog" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://scriptoverture.github.io/blog/" title="é¦–é¡µ" target="">é¦–é¡µ</a></li><li> <a href="https://scriptoverture.github.io/blog/categories/" title="åˆ†ç±»" target="">åˆ†ç±»</a></li><li> <a href="https://scriptoverture.github.io/blog/archives/" title="å½’æ¡£" target="">å½’æ¡£</a></li><li> <a href="https://scriptoverture.github.io/blog/open-source/" title="å¼€æº" target="">å¼€æº</a></li><li> <a href="https://scriptoverture.github.io/blog/fragments/" title="ç‰‡æ®µ" target="">ç‰‡æ®µ</a></li><li> <a href="https://scriptoverture.github.io/blog/wiki/" title="ç»´åŸº" target="">ç»´åŸº</a></li><li> <a href="https://scriptoverture.github.io/blog/links/" title="é“¾æ¥" target="">é“¾æ¥</a></li><li> <a href="https://scriptoverture.github.io/blog/about/" title="å…³äº" target="">å…³äº</a></li><li><a href="https://scriptoverture.github.io/blog/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="å›åˆ°é¡¶éƒ¨"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://scriptoverture.github.io/blog/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
